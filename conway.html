<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de la Vida de Conway ‚Äî Mapa infinito + Pan con click derecho</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body { margin: 0; height: 100vh; overflow: hidden; font-family: 'Press Start 2P', system-ui, sans-serif; background: radial-gradient(circle at top, #1a1f2b 0%, #0a0d14 55%, #05070c 100%); color: #f0f6ff; }

    /* Canvas a pantalla completa */
    #lifeCanvas { position: fixed; inset: 0; width: 100vw; height: 100vh; display: block; background: rgba(0,0,0,0.92); image-rendering: pixelated; touch-action: none; }

    /* HUD fijo */
    .hud { position: fixed; z-index: 10; left: 0; right: 0; top: 0; display: grid; gap: .5rem; padding: .6rem 1rem .8rem; background: linear-gradient(to bottom, rgba(10,16,27,.85), rgba(10,16,27,.35)); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(69,240,255,.25); }
    .hud .row { display: flex; flex-wrap: wrap; gap: .5rem .75rem; align-items: center; justify-content: center; }
    .chip, .hud button { padding: .45rem .9rem; font-size: .75rem; color: #0a0d14; background: #45f0ff; border-radius: 8px; border: none; font-weight: bold; letter-spacing: 1px; box-shadow: 0 2px 8px rgba(69, 240, 255, 0.4); text-decoration: none; cursor: pointer; }
    .btn { border: 2px solid #45f0ff; background: rgba(25,38,56,0.7); color: #45f0ff; border-radius: 10px; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 0 10px rgba(69,240,255,.35); }

    .status { display: flex; flex-wrap: wrap; gap: .8rem 1rem; align-items: center; justify-content: center; color: #9fe8ff; font-size: .85rem; }
    .control { display: flex; align-items: center; gap: .5rem; }
    input[type="range"] { accent-color: #45f0ff; cursor: pointer; }

    details.testlog { position: fixed; right: .5rem; bottom: .5rem; z-index: 11; width: min(86vw, 460px); background: rgba(69,240,255,.06); border: 1px dashed rgba(69,240,255,.3); border-radius: 10px; padding: .4rem .6rem; }
    details.testlog summary { cursor: pointer; }
    .pass { color: #7fffb0; }
    .fail { color: #ff8080; }
  </style>
</head>
<body>
  <!-- HUD superior -->
  <div class="hud" role="toolbar" aria-label="Controles del Juego de la Vida">
    <div class="row">
      <a href="./index.html" class="chip" aria-label="Volver al men√∫">Men√∫</a>
      <button class="chip" id="helpBtn" aria-haspopup="dialog" aria-controls="helpDialog">Info</button>
    </div>
    <div class="row">
      <button id="playPause" class="btn" aria-pressed="false">‚ñ∂Ô∏è Iniciar</button>
      <button id="step" class="btn">‚è≠Ô∏è Paso</button>
      <button id="clear" class="btn">üßπ Limpiar</button>
      <button id="random" class="btn">üé≤ Aleatorio</button>
    </div>
    <div class="row status">
      <span id="generation" aria-live="polite">Generaci√≥n: 0</span>
      <div class="control"><label for="speed">Velocidad</label><input type="range" id="speed" min="50" max="600" step="10" value="200" /><span id="speedValue">200 ms</span></div>
      <div class="control"><label for="zoom">Zoom</label><input type="range" id="zoom" min="50" max="300" step="5" value="100" /><span id="zoomValue">100%</span></div>
      <span id="living" aria-live="polite">Vivas: 0</span>
    </div>
  </div>

  <canvas id="lifeCanvas" width="600" height="600" aria-label="Tablero del Juego de la Vida"></canvas>

  <details class="testlog"><summary>Ver resultados de pruebas</summary>
    <ul id="testResults" style="margin:.5rem 0 0 1rem"></ul>
  </details>

  <dialog id="helpDialog">
    <div class="modal-header">
      <h2 style="margin: .5rem 0">¬øC√≥mo funciona?</h2>
      <form method="dialog"><button>‚úñ</button></form>
    </div>
    <div class="modal-body">
      <p>El <strong>Juego de la Vida</strong> ahora usa un <em>mapa infinito</em>. Haz click izquierdo para activar/desactivar c√©lulas. Mant√©n <strong>click derecho</strong> para <strong>moverte (pan)</strong>. Rueda para zoom.</p>
      <ul>
        <li>Una c√©lula viva sobrevive con 2 o 3 vecinas vivas.</li>
        <li>Una c√©lula muerta nace con exactamente 3 vecinas vivas.</li>
        <li>La simulaci√≥n se detiene si el patr√≥n se estabiliza.</li>
      </ul>
    </div>
  </dialog>

  <script>
  'use strict';
  (function(){
    // ===== DOM =====
    var canvas = document.getElementById('lifeCanvas');
    var ctx = canvas.getContext('2d', {alpha:false});
    var playPauseBtn = document.getElementById('playPause');
    var stepBtn = document.getElementById('step');
    var clearBtn = document.getElementById('clear');
    var randomBtn = document.getElementById('random');
    var speedInput = document.getElementById('speed');
    var speedValue = document.getElementById('speedValue');
    var zoomInput = document.getElementById('zoom');
    var zoomValue = document.getElementById('zoomValue');
    var generationLabel = document.getElementById('generation');
    var livingLabel = document.getElementById('living');
    var helpBtn = document.getElementById('helpBtn'); var helpDialog = document.getElementById('helpDialog');
    helpBtn.addEventListener('click', function(){ helpDialog.showModal(); });

    // ===== Estado infinito (sparse set) =====
    // set de claves "x,y" para celdas vivas en coordenadas enteras
    var live = new Set();
    var generation = 0;
    var running = false; var timer = null;
    var painting = false; var paintState = 1;

    // Vista (pan/zoom)
    var baseCell = 22; // px a 100%
    var zoom = 1; // 1 = 100%
    var cellPx = baseCell * zoom;
    var originX = 0; // coordenada de celda en el borde izquierdo de pantalla
    var originY = 0; // coordenada de celda en el borde superior

    // Pan con click derecho
    var panning = false; var panStartX = 0; var panStartY = 0; var originStartX = 0; var originStartY = 0;

    // ===== Utilidades =====
    function key(x,y){ return x+','+y; }
    function has(x,y){ return live.has(key(x,y)); }
    function add(x,y){ live.add(key(x,y)); }
    function del(x,y){ live.delete(key(x,y)); }

    function clamp(v,min,max){ return Math.min(Math.max(v,min),max); }

    function fitCanvas(){
      var dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
      var w = Math.round(window.innerWidth), h = Math.round(window.innerHeight);
      canvas.style.width = w+'px'; canvas.style.height = h+'px';
      if(canvas.width !== w*dpr || canvas.height !== h*dpr){ canvas.width = w*dpr; canvas.height = h*dpr; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); }
    }

    function screenToWorld(xPx,yPx){
      return { x: Math.floor(originX + xPx / cellPx), y: Math.floor(originY + yPx / cellPx) };
    }

    function worldToScreen(x,y){
      return { x: Math.round((x - originX) * cellPx), y: Math.round((y - originY) * cellPx) };
    }

    function draw(){
      ctx.imageSmoothingEnabled = false;
      var w = window.innerWidth, h = window.innerHeight;
      ctx.fillStyle = 'rgba(5,9,18,0.95)'; ctx.fillRect(0,0,w,h);

      // rejilla
      ctx.strokeStyle = 'rgba(69,240,255,0.12)'; ctx.lineWidth = 1;
      var startX = Math.floor(originX), startY = Math.floor(originY);
      var endX = Math.ceil(originX + w/cellPx), endY = Math.ceil(originY + h/cellPx);
      var i, px;
      for(i=startX;i<=endX;i++){ px = Math.round((i-originX)*cellPx)+0.5; ctx.beginPath(); ctx.moveTo(px,0); ctx.lineTo(px,h); ctx.stroke(); }
      for(i=startY;i<=endY;i++){ px = Math.round((i-originY)*cellPx)+0.5; ctx.beginPath(); ctx.moveTo(0,px); ctx.lineTo(w,px); ctx.stroke(); }

      // c√©lulas vivas visibles
      ctx.fillStyle = '#45f0ff';
      var pad = Math.max(1, Math.floor(cellPx*0.12));
      var size = Math.max(0, Math.round(cellPx - pad*2));
      live.forEach(function(k){
        var parts = k.split(','); var x = parseInt(parts[0],10), y = parseInt(parts[1],10);
        if(x>=startX-1 && x<=endX+1 && y>=startY-1 && y<=endY+1){
          var sp = worldToScreen(x,y);
          ctx.fillRect(sp.x + pad, sp.y + pad, size, size);
        }
      });

      // stats
      livingLabel.textContent = 'Vivas: ' + live.size;
      generationLabel.textContent = 'Generaci√≥n: ' + generation;
    }

    function step(){
      // Conteo de vecinos para mapa infinito
      var counts = new Map();
      live.forEach(function(k){
        var p = k.split(','); var x = parseInt(p[0],10), y = parseInt(p[1],10);
        var dx, dy, nk;
        for(dx=-1;dx<=1;dx++) for(dy=-1;dy<=1;dy++){
          if(dx===0 && dy===0) continue;
          nk = (x+dx)+','+(y+dy);
          counts.set(nk, (counts.get(nk)||0)+1);
        }
      });
      var next = new Set();
      // Sobreviven vivas con 2 o 3; nacen muertas con 3
      // A√±adir tambi√©n vivas que quiz√° no aparezcan en counts (sin vecinos -> mueren)
      live.forEach(function(k){ var n = counts.get(k)||0; if(n===2 || n===3) next.add(k); });
      counts.forEach(function(n, k){ if(n===3) next.add(k); });

      var changed = (next.size !== live.size);
      if(!changed){ // tama√±os iguales, comprobar diferencias
        live.forEach(function(k){ if(!next.has(k)) changed = true; });
      }
      live = next; generation++;
      draw();
      if(!changed) stop();
    }

    function play(){ if(running) return; running=true; playPauseBtn.textContent='‚è∏Ô∏è Pausar'; playPauseBtn.setAttribute('aria-pressed','true'); timer=setInterval(step, currentDelay()); }
    function stop(){ if(!running) return; running=false; playPauseBtn.textContent='‚ñ∂Ô∏è Iniciar'; playPauseBtn.setAttribute('aria-pressed','false'); if(timer){clearInterval(timer); timer=null;} }
    function currentDelay(){ var min=Number(speedInput.min)||50, max=Number(speedInput.max)||600, raw=Number(speedInput.value)||200; return min + max - raw; }

    // ===== Interacci√≥n =====
    // Evitar men√∫ contextual al usar click derecho para pan
    canvas.addEventListener('contextmenu', function(e){ e.preventDefault(); });

    canvas.addEventListener('pointerdown', function(ev){
      var rect = canvas.getBoundingClientRect(); var x = ev.clientX - rect.left; var y = ev.clientY - rect.top;
      if(ev.button === 2){ // pan
        panning = true; panStartX = x; panStartY = y; originStartX = originX; originStartY = originY; return;
      }
      var cell = screenToWorld(x,y);
      paintState = has(cell.x, cell.y) ? 0 : 1;
      painting = true; setCell(cell.x, cell.y, paintState);
      canvas.setPointerCapture(ev.pointerId);
    });

    canvas.addEventListener('pointermove', function(ev){
      var rect = canvas.getBoundingClientRect(); var x = ev.clientX - rect.left; var y = ev.clientY - rect.top;
      if(panning){
        var dx = (x - panStartX) / cellPx; var dy = (y - panStartY) / cellPx;
        originX = originStartX - dx; originY = originStartY - dy; draw(); return;
      }
      if(!painting) return; var cell = screenToWorld(x,y); setCell(cell.x, cell.y, paintState);
    });

    function endPointer(){ painting=false; panning=false; }
    canvas.addEventListener('pointerup', endPointer); canvas.addEventListener('pointercancel', endPointer); canvas.addEventListener('pointerleave', endPointer);

    // Zoom
    function applyZoom(){ var percent = Number(zoomInput.value)||100; zoom = clamp(percent/100, 0.5, 3); cellPx = baseCell * zoom; zoomValue.textContent = Math.round(zoom*100)+'%'; draw(); }
    zoomInput.addEventListener('input', applyZoom);
    canvas.addEventListener('wheel', function(ev){ ev.preventDefault(); var cur = Number(zoomInput.value)||100; var next = clamp(cur + (ev.deltaY>0?-5:5), Number(zoomInput.min)||50, Number(zoomInput.max)||300); zoomInput.value = String(next); applyZoom(); }, {passive:false});

    // Controladores HUD
    playPauseBtn.addEventListener('click', function(){ running?stop():play(); });
    stepBtn.addEventListener('click', function(){ if(running) stop(); step(); });
    clearBtn.addEventListener('click', function(){ stop(); live.clear(); generation=0; draw(); });
    randomBtn.addEventListener('click', function(){
      stop(); // rellena aleatorio en el √°rea visible
      var w = window.innerWidth, h = window.innerHeight; var startX = Math.floor(originX), startY = Math.floor(originY); var endX = Math.ceil(originX + w/cellPx), endY = Math.ceil(originY + h/cellPx);
      var density = 0.25; // un poco menos denso para infinito
      for(var y=startY; y<=endY; y++) for(var x=startX; x<=endX; x++) if(Math.random()<density) add(x,y); generation=0; draw();
    });

    speedInput.addEventListener('input', function(){ var del = currentDelay(); speedValue.textContent = del + ' ms'; if(running){ clearInterval(timer); timer=setInterval(step, del); } });

    function setCell(x,y,state){ if(state){ add(x,y); } else { del(x,y); } draw(); }

    // Layout b√°sico
    function relayout(){ fitCanvas(); draw(); }
    window.addEventListener('resize', relayout, {passive:true});
    document.addEventListener('visibilitychange', function(){ if(document.hidden) stop(); });

    // Init
    (function init(){ var del = currentDelay(); speedValue.textContent = del + ' ms'; applyZoom(); relayout(); })();

    // ===== PRUEBAS (no modificadas + extra) =====
    function deepEqual(a,b){ return JSON.stringify(a) === JSON.stringify(b); }
    function emptyGrid(r,c){ var A=[], i; for(i=0;i<r;i++){ A.push(Array(c).fill(0)); } return A; }
    function stepOnce(g){ var r=g.length, c=g[0].length; var out=emptyGrid(r,c); function nb(i,j){ var k=0; for(var di=-1;di<=1;di++) for(var dj=-1;dj<=1;dj++){ if(!di&&!dj) continue; var ii=i+di,jj=j+dj; if(ii>=0&&ii<r&&jj>=0&&jj<c) k+=g[ii][jj]; } return k; } for(var i=0;i<r;i++) for(var j=0;j<c;j++){ var n=nb(i,j); var alive=g[i][j]===1; out[i][j]=alive?(n===2||n===3?1:0):(n===3?1:0);} return out; }
    var tests=[];
    tests.push({name:'Vac√≠o estable', run:function(){ var g=[[0,0],[0,0]]; return deepEqual(g, stepOnce(g)); }});
    tests.push({name:'Bloque 2x2 estable', run:function(){ var g=[[0,0,0],[0,1,1],[0,1,1]]; return deepEqual(g, stepOnce(g)); }});
    tests.push({name:'Blinker oscila', run:function(){ var g=[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]]; var g1=stepOnce(g); var g2=stepOnce(g1); return deepEqual(g,g2); }});
    tests.push({name:'Nacimiento con 3', run:function(){ var g=[[1,1,0],[1,0,0],[0,0,0]]; var g1=stepOnce(g); return g1[1][1]===1; }});
    tests.push({name:'Toad oscila', run:function(){ var g=[[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,1,1,1,0],[0,1,1,1,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0]]; var g1=stepOnce(g); var g2=stepOnce(g1); return deepEqual(g,g2); }});
    tests.push({name:'Boat estable', run:function(){ var g=[[0,1,0,0],[1,0,1,0],[0,1,0,1],[0,0,1,0]]; return deepEqual(g, stepOnce(g)); }});
    // Extra: Glider se desplaza 1 celda diagonal cada 4 pasos (en mundo finito ideal). Aqu√≠ validamos que no desaparece tras 4 pasos.
    tests.push({name:'Glider persiste 4 pasos', run:function(){ var g=[[0,1,0],[0,0,1],[1,1,1]]; var s=g; for(var t=0;t<4;t++){ s=stepOnce(s);} var sum=0; for(var i=0;i<s.length;i++) for(var j=0;j<s[0].length;j++) sum+=s[i][j]; return sum>0; }});
    var resultsEl=document.getElementById('testResults'); tests.forEach(function(t){ var ok=false; try{ ok=!!t.run(); }catch(_){ ok=false; } var li=document.createElement('li'); li.className=ok?'pass':'fail'; li.textContent=(ok?'‚úî':'‚úò')+' '+t.name; resultsEl.appendChild(li); });
  })();
  </script>
</body>
</html>
