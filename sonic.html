<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="stylesheet" href="responsive.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Sonic</title>
  <style>
    body { margin:0; overflow:hidden; }
    canvas {
      background: linear-gradient(#87CEEB, #1E90FF);
      display:block; margin:0 auto;
    }
    /* Botones de menú e información */
    .game-buttons {
      background-color:#ffffff;
      color:#e74c3c;
      font-weight:bold;
      text-decoration:none;
      padding:10px 20px;
      border-radius:5px;
      position:absolute;
      top:10px;
      z-index:10;
    }
    .menu-button { right:10px; }
    .help-button { left:10px; }
    #level-message {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:20px 40px;
      font:32px sans-serif;
      border:2px solid #fff;
      border-radius:10px;
      display:none;
      z-index:20;
    }
  </style>
</head>
<body>
  <a href="./index.html" class="menu-button game-buttons">Menu</a>
  <button class="help-button game-buttons" data-help="Corre por escenarios laterales, recoge todas las monedas y pulsa el botón rojo para avanzar.">Info</button>
  <div id="level-message"></div>
  <canvas id="game" width="800" height="400"></canvas>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const keys = { left:false, right:false };
    const gravity = 0.6;
    const player = { x:50, y:0, w:40, h:40, vx:0, vy:0, speed:3.5, jump:12, onGround:false };
    const world = { height:canvas.height, ground:80 };
    let level = {};
    let platforms = [];
    let obstacles = [];
    let spikes = [];
    let coins = [];
    let goal = {};
    let clouds = [];
    let cameraX = 0;
    let currentLevel = 0;
    let levelTransition = false;
    let lives = 3;
    let score = 0;
    let controlsLocked = false;

    function randomInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const groundCanvas = document.createElement('canvas');
    groundCanvas.width = groundCanvas.height = 40;
    const gctx = groundCanvas.getContext('2d');
    gctx.fillStyle = '#228B22';
    gctx.fillRect(0,0,40,20);
    gctx.fillStyle = '#006400';
    gctx.fillRect(0,20,40,20);
    const groundPattern = ctx.createPattern(groundCanvas, 'repeat');

    const goalCanvas = document.createElement('canvas');
    goalCanvas.width = goalCanvas.height = 20;
    const goalCtx = goalCanvas.getContext('2d');
    goalCtx.fillStyle = '#fff';
    goalCtx.fillRect(0,0,20,20);
    goalCtx.fillStyle = '#000';
    goalCtx.fillRect(0,0,10,10);
    goalCtx.fillRect(10,10,10,10);
    const goalPattern = ctx.createPattern(goalCanvas, 'repeat');

    document.addEventListener('keydown', e => {
      if(controlsLocked) return;
      if(e.code === 'ArrowLeft') keys.left = true;
      if(e.code === 'ArrowRight') keys.right = true;
      if((e.code === 'ArrowUp' || e.code === 'Space') && player.onGround){
        player.vy = -player.jump;
        player.onGround = false;
      }
    });
    document.addEventListener('keyup', e => {
      if(controlsLocked) return;
      if(e.code === 'ArrowLeft') keys.left = false;
      if(e.code === 'ArrowRight') keys.right = false;
    });

    const messageBox = document.getElementById('level-message');
    function showMessage(text){
      messageBox.textContent = text;
      messageBox.style.display = 'block';
      setTimeout(()=>{ messageBox.style.display = 'none'; },3000);
    }

    function loadLevel(idx){
      const width = randomInt(2000, 3000);
      level = { width, height:world.height, ground:world.ground };
      platforms = [];
      let px = 600;
      while(px < width - 400){
        const w = randomInt(80,160);
        const diff = randomInt(80,200);
        const y = world.height - world.ground - diff;
        platforms.push({x:px, y:y, w:w, h:20});
        if(diff > 120){
          platforms.push({x:px - w/2, y:y + 80, w:w, h:20});
        }
        px += w + randomInt(200,400);
      }
      obstacles = [];
      spikes = [];
      let hx = 400;
      while(hx < width - 200){
        const overlapsPlatform = platforms.some(p => hx + 40 > p.x && hx < p.x + p.w);
        if(!overlapsPlatform){
          if(Math.random() < 0.5){
            obstacles.push({x:hx, y:world.height - world.ground - 30, w:40, h:30});
          }else{
            spikes.push({x:hx, y:world.height - world.ground - 30, w:40, h:30});
          }
          hx += randomInt(300,600);
        }else{
          hx += 100;
        }
      }
      coins = [];
      for(let i=200;i<width-200;i+=200){
        const nearSolid = obstacles.concat(spikes).some(s => i > s.x - 40 && i < s.x + s.w + 40);
        if(!nearSolid){
          coins.push({x:i, y:world.height - world.ground - 40, r:15, collected:false});
        }
      }
      platforms.forEach(p => {
        coins.push({x:p.x + p.w/2, y:p.y - 20, r:15, collected:false});
      });
      goal = { x:width - 100, y:world.height - world.ground - 50, w:40, h:40, pressed:false };
      clouds = [];
      for(let i=0;i<5;i++){
        clouds.push({x:Math.random()*width, y:20+Math.random()*80, w:80+Math.random()*40, h:40+Math.random()*20, speed:0.2+Math.random()*0.3});
      }
      player.x = 50;
      player.y = world.height - world.ground - player.h;
      player.vx = player.vy = 0;
      cameraX = 0;
      controlsLocked = false;
      showMessage(`Nivel ${idx+1}`);
    }

    function levelComplete(){
      if(levelTransition) return;
      levelTransition = true;
      goal.pressed = true;
      controlsLocked = true;
      keys.left = keys.right = false;
      player.vx = player.vy = 0;
      showMessage('Nivel completado');
      setTimeout(()=>{
        currentLevel++;
        loadLevel(currentLevel);
        levelTransition = false;
      },3000);
    }

    function allCoins(){
      return coins.every(c => c.collected);
    }

    function loseLife(){
      if(levelTransition) return;
      lives--;
      if(lives > 0){
        loadLevel(currentLevel);
      }else{
        showMessage('Game Over');
        setTimeout(()=>{
          lives = 3;
          currentLevel = 0;
          score = 0;
          loadLevel(currentLevel);
        },3000);
      }
    }

    function drawCloud(cl){
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(cl.x + cl.w*0.2, cl.y + cl.h*0.5, cl.h*0.5, 0, Math.PI*2);
      ctx.arc(cl.x + cl.w*0.5, cl.y + cl.h*0.4, cl.h*0.6, 0, Math.PI*2);
      ctx.arc(cl.x + cl.w*0.8, cl.y + cl.h*0.5, cl.h*0.5, 0, Math.PI*2);
      ctx.fill();
    }

    function update(){
      if(!controlsLocked){
        player.vx = 0;
        if(keys.left) player.vx = -player.speed;
        if(keys.right) player.vx = player.speed;
        player.vy += gravity;
        const prevX = player.x;
        const prevY = player.y;
        player.x += player.vx;
        player.y += player.vy;
        player.onGround = false;

        if(player.y + player.h > level.height - level.ground){
          player.y = level.height - level.ground - player.h;
          player.vy = 0;
          player.onGround = true;
        }

        const solids = obstacles.concat(spikes);
        solids.forEach(s => {
          if(player.x < s.x + s.w && player.x + player.w > s.x &&
             player.y < s.y + s.h && player.y + player.h > s.y){
            const prevBottom = prevY + player.h;
            const prevTop = prevY;
            const prevRight = prevX + player.w;
            const prevLeft = prevX;
            if(prevBottom <= s.y){
              player.y = s.y - player.h;
              player.vy = 0;
              player.onGround = true;
            }else if(prevTop >= s.y + s.h){
              player.y = s.y + s.h;
              player.vy = 0;
            }else if(prevRight <= s.x){
              player.x = s.x - player.w;
            }else if(prevLeft >= s.x + s.w){
              player.x = s.x + s.w;
            }
          }
        });

        platforms.forEach(p => {
          const prevBottom = prevY + player.h;
          if(player.x < p.x + p.w && player.x + player.w > p.x &&
             player.y + player.h > p.y && prevBottom <= p.y && player.vy >= 0){
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
          }
        });

        if(player.x < 0) player.x = 0;
        if(player.x + player.w > level.width) player.x = level.width - player.w;

        spikes.forEach(s => {
          if(player.x < s.x + s.w && player.x + player.w > s.x &&
             player.y < s.y + s.h && player.y + player.h >= s.y){
            loseLife();
          }
        });

        coins.forEach(c => {
          const dx = player.x + player.w/2 - c.x;
          const dy = player.y + player.h/2 - c.y;
          if(!c.collected && Math.hypot(dx,dy) < c.r + player.w/2){
            c.collected = true;
            score++;
          }
        });

        if(allCoins() &&
           player.x + player.w > goal.x && player.x < goal.x + goal.w &&
           player.y + player.h > goal.y && player.y < goal.y + goal.h){
          levelComplete();
        }
      }

      cameraX = player.x - canvas.width/2;
      cameraX = Math.max(0, Math.min(cameraX, level.width - canvas.width));

      clouds.forEach(cl => {
        cl.x -= cl.speed;
        if(cl.x + cl.w < 0){
          cl.x = level.width + Math.random()*100;
          cl.y = 20 + Math.random()*80;
        }
      });
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save();
      ctx.translate(-cameraX*0.5,0);
      clouds.forEach(drawCloud);
      ctx.restore();
      ctx.save();
      ctx.translate(-cameraX,0);
      ctx.fillStyle = groundPattern;
      ctx.fillRect(0, level.height - level.ground, level.width, level.ground);
      platforms.forEach(p => {
        ctx.fillStyle = '#8B4513';
        ctx.fillRect(p.x, p.y, p.w, p.h);
      });
      obstacles.forEach(o => {
        ctx.fillStyle = '#555';
        ctx.fillRect(o.x, o.y, o.w, o.h);
      });
      spikes.forEach(s => {
        ctx.fillStyle = '#888';
        ctx.beginPath();
        ctx.moveTo(s.x, s.y + s.h);
        ctx.lineTo(s.x + s.w/2, s.y);
        ctx.lineTo(s.x + s.w, s.y + s.h);
        ctx.closePath();
        ctx.fill();
      });
      coins.forEach(c => {
        if(!c.collected){
          ctx.beginPath();
          ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
          ctx.fillStyle = 'gold';
          ctx.fill();
          ctx.strokeStyle = '#cc0';
          ctx.stroke();
        }
      });
      ctx.fillStyle = goalPattern;
      ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
      if(goal.pressed){
        ctx.fillStyle = 'rgba(0,255,0,0.5)';
        ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
      }
      ctx.fillStyle = 'blue';
      ctx.fillRect(player.x, player.y, player.w, player.h);
      ctx.restore();
      ctx.fillStyle = '#fff';
      ctx.font = '20px sans-serif';
      ctx.textAlign = 'right';
      ctx.fillText('Vidas: ' + lives, canvas.width - 10, canvas.height - 10);
      ctx.textAlign = 'left';
      ctx.fillText('Puntuación: ' + score, 10, 30);
    }

    function loop(){
      update();
      draw();
      requestAnimationFrame(loop);
    }

    loadLevel(currentLevel);
    loop();
  </script>
<script src="help-modal.js"></script>
</body>
</html>
