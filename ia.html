<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Chat</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Prism (código) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9.0.0/themes/prism-tomorrow.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/9.0.0/components/prism-core.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/9.0.0/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- MathJax (LaTeX) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    };
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { 500: '#10a37f', 600: '#0e8c6d' }
          }
        }
      }
    }
  </script>

  <style>
    /* Mejora de bloques de código (sin @apply, porque con CDN no compila) */
    pre[class*="language-"] {
      border-radius: 0.75rem;
      margin: 0.75rem 0 !important;
      padding: 1rem !important;
      font-size: 0.875rem !important;
      overflow: auto;
    }
    code[class*="language-"] {
      font-size: 0.875rem !important;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 flex flex-col border-r border-gray-200 dark:border-gray-700 transition-transform duration-300 md:translate-x-0 -translate-x-full">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <h1 class="text-xl font-bold text-primary-500">Gemini Chat</h1>
        <div class="mt-4 flex justify-between items-center">
          <button id="new-chat-btn" class="px-3 py-1.5 bg-primary-500 text-white rounded-md text-sm hover:bg-primary-600 transition">+ Nueva conversación</button>
          <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Cambiar tema">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          </button>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-2">
        <h2 class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">Historial</h2>
        <div id="history-list" class="space-y-1"></div>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col">
      <!-- Mobile sidebar toggle -->
      <div class="md:hidden p-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <button id="mobile-menu-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Abrir menú">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>

      <!-- Chat messages -->
      <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6">
        <div class="max-w-3xl mx-auto w-full space-y-6">
          <!-- Mensajes se insertan aquí -->
        </div>
      </div>

      <!-- Input area -->
      <div class="border-t border-gray-200 dark:border-gray-700 p-4 bg-white dark:bg-gray-800">
        <div class="max-w-3xl mx-auto">
          <form id="chat-form" class="relative">
            <textarea
              id="user-input"
              placeholder="Escribe tu mensaje..."
              class="w-full min-h-[60px] max-h-32 p-4 pr-12 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:outline-none focus:ring-2 focus:ring-primary-500"
            ></textarea>
            <button
              type="submit"
              class="absolute right-3 bottom-3 bg-primary-500 text-white p-2 rounded-full hover:bg-primary-600 transition"
              aria-label="Enviar"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
          </form>

          <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
            <button id="clear-chat" class="hover:underline">Borrar conversación</button>
            <span>Presiona Enter para enviar</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ====== JS ======

    // ⚠️ No pongas tu API key en frontend en producción.
    const API_KEY1 = 'AIzaSyA9peSXzs_BLjQuoRwxm';
    const API_KEY2 = 'AplILDb3PDdGz8';
    const API_KEY =API_KEY1+API_KEY2;
    
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-lite-latest:generateContent?key=${API_KEY}`;

    let conversation = [];
    let currentSessionId = Date.now().toString();
    let lastRequestTime = 0;
    const RATE_LIMIT_DELAY = 1000;

    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const chatForm = document.getElementById('chat-form');
    const clearChatBtn = document.getElementById('clear-chat');
    const newChatBtn = document.getElementById('new-chat-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');
    const historyList = document.getElementById('history-list');

    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      loadHistory();
      renderHistory();
    });

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      const now = Date.now();
      if (now - lastRequestTime < RATE_LIMIT_DELAY) {
        alert('Espera un momento antes de enviar otro mensaje.');
        return;
      }
      lastRequestTime = now;

      addMessageToDOM(message, 'user');
      conversation.push({ role: 'user', parts: [{ text: message }] });
      saveConversation();

      userInput.value = '';
      userInput.style.height = 'auto';

      const aiMessageEl = addMessageToDOM('', 'ai', true);
      scrollToBottom();

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: conversation,
            generationConfig: { maxOutputTokens: 2048, temperature: 0.7 }
          })
        });

        if (!response.ok) throw new Error(`Error: ${response.status}`);

        const data = await response.json();
        const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? 'Sin respuesta.';

        conversation.push({ role: 'model', parts: [{ text: aiText }] });
        saveConversation();

        await typeWriter(aiText, aiMessageEl);

        // Resaltar código
        highlightCodeBlocks();

        // Renderizar LaTeX (MathJax) SOLO en el mensaje nuevo
        typesetMath(aiMessageEl);

        scrollToBottom();
      } catch (error) {
        console.error('API Error:', error);
        aiMessageEl.className = bubbleAiClass();
        aiMessageEl.textContent = 'Lo siento, hubo un error al procesar tu solicitud. Intenta de nuevo.';
      }
    }

    // --- Burbujas estilo ChatGPT (Tailwind directo) ---
    function bubbleUserClass() {
      return [
        "max-w-[85%]",
        "ml-auto",
        "rounded-3xl",
        "rounded-br-md",
        "px-5",
        "py-3",
        "bg-primary-500",
        "text-white",
        "shadow-sm",
        "whitespace-pre-wrap",
        "break-words"
      ].join(" ");
    }

    function bubbleAiClass() {
      return [
        "max-w-[85%]",
        "mr-auto",
        "rounded-3xl",
        "rounded-bl-md",
        "px-5",
        "py-3",
        "bg-gray-100",
        "dark:bg-gray-800",
        "text-gray-900",
        "dark:text-gray-100",
        "shadow-sm",
        "whitespace-pre-wrap",
        "break-words"
      ].join(" ");
    }

    function typingClass() {
      return [
        "max-w-[85%]",
        "mr-auto",
        "rounded-3xl",
        "rounded-bl-md",
        "px-5",
        "py-3",
        "bg-gray-100",
        "dark:bg-gray-800",
        "text-gray-700",
        "dark:text-gray-200",
        "shadow-sm"
      ].join(" ");
    }

    function addMessageToDOM(text, sender, isTyping = false) {
      const row = document.createElement('div');
      row.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';

      const bubble = document.createElement('div');

      if (isTyping) {
        bubble.className = typingClass();
        bubble.innerHTML = '<span class="animate-pulse">...</span>';
      } else if (sender === 'user') {
        bubble.className = bubbleUserClass();
        bubble.textContent = text;
      } else {
        bubble.className = bubbleAiClass();
        // Importante: NO convertimos \n a <br>. Usamos whitespace-pre-wrap.
        bubble.innerHTML = marked.parse(text);
      }

      row.appendChild(bubble);
      chatContainer.querySelector('.max-w-3xl').appendChild(row);
      return bubble;
    }

    async function typeWriter(text, element) {
      // Quitamos typing
      element.className = bubbleAiClass();
      element.innerHTML = '';

      const tokens = text.split('');
      for (let i = 0; i < tokens.length; i++) {
        // Si detecta bloque de código, lo mete completo para no romperlo
        if (text.substring(i, i + 3) === '```') {
          const end = text.indexOf('```', i + 3);
          if (end !== -1) {
            element.innerHTML += marked.parse(text.substring(i, end + 3));
            i = end + 2;
            continue;
          }
        }
        element.textContent += tokens[i]; // textContent para no romper LaTeX a mitad
        await new Promise(r => setTimeout(r, 10));
      }

      // Al final, renderizamos markdown completo (incluye links/code)
      element.innerHTML = marked.parse(text);
    }

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // --- MathJax ---
    function typesetMath(containerEl) {
      if (window.MathJax?.typesetPromise) {
        window.MathJax.typesetClear?.([containerEl]);
        window.MathJax.typesetPromise([containerEl]).catch(err => console.error('MathJax:', err));
      }
    }

    // --- HISTORIAL ---
    function saveConversation() {
      const history = JSON.parse(localStorage.getItem('chatHistory') || '{}');
      history[currentSessionId] = {
        title:
          (conversation[0]?.parts?.[0]?.text
            ? conversation[0].parts[0].text.substring(0, 30) + (conversation[0].parts[0].text.length > 30 ? '...' : '')
            : 'Nueva conversación'),
        conversation
      };
      localStorage.setItem('chatHistory', JSON.stringify(history));
      renderHistory();
    }

    function loadHistory() {
      const saved = localStorage.getItem('chatHistory');
      if (saved) {
        const history = JSON.parse(saved);
        const ids = Object.keys(history);
        if (ids.length > 0) {
          currentSessionId = ids[0];
          conversation = history[currentSessionId].conversation || [];
          renderConversation();
        }
      }
    }

    function renderHistory() {
      historyList.innerHTML = '';
      const history = JSON.parse(localStorage.getItem('chatHistory') || '{}');
      Object.entries(history).reverse().forEach(([id, data]) => {
        const btn = document.createElement('button');
        btn.className = `w-full text-left px-3 py-2 rounded-md text-sm truncate ${
          id === currentSessionId ? 'bg-gray-200 dark:bg-gray-700 font-medium' : 'hover:bg-gray-100 dark:hover:bg-gray-700'
        }`;
        btn.textContent = data.title;
        btn.onclick = () => loadSession(id);
        historyList.appendChild(btn);
      });
    }

    function loadSession(id) {
      const history = JSON.parse(localStorage.getItem('chatHistory') || '{}');
      if (history[id]) {
        currentSessionId = id;
        conversation = history[id].conversation || [];
        renderConversation();
        renderHistory();
      }
    }

    function renderConversation() {
      chatContainer.querySelector('.max-w-3xl').innerHTML = '';
      conversation.forEach(msg => {
        const sender = msg.role === 'user' ? 'user' : 'ai';
        addMessageToDOM(msg.parts[0].text, sender);
      });
      highlightCodeBlocks();
      // Renderizar LaTeX de todos los mensajes al cargar historial
      typesetMath(chatContainer);
      scrollToBottom();
    }

    // --- EVENTOS ---
    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      sendMessage();
    });

    userInput.addEventListener('input', () => {
      userInput.style.height = 'auto';
      userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
    });

    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    clearChatBtn.addEventListener('click', () => {
      if (confirm('¿Borrar esta conversación?')) {
        conversation = [];
        chatContainer.querySelector('.max-w-3xl').innerHTML = '';
        const history = JSON.parse(localStorage.getItem('chatHistory') || '{}');
        delete history[currentSessionId];
        localStorage.setItem('chatHistory', JSON.stringify(history));
        currentSessionId = Date.now().toString();
        renderHistory();
      }
    });

    newChatBtn.addEventListener('click', () => {
      conversation = [];
      chatContainer.querySelector('.max-w-3xl').innerHTML = '';
      currentSessionId = Date.now().toString();
      renderHistory();
    });

    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    mobileMenuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
    });

    // --- UTILIDADES ---
    function loadTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
    }

    function highlightCodeBlocks() {
      document.querySelectorAll('pre code').forEach(block => Prism.highlightElement(block));
    }

    // Markdown renderer ligero (conserva $...$ y $$...$$ para MathJax)
    const marked = {
      parse: (str) => {
        // Escapar HTML básico (seguro)
        str = str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');

        // Bloques de código ```lang ... ```
        str = str.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
          const language = lang || 'plaintext';
          return `<pre><code class="language-${language}">${code.replace(/^\n+|\n+$/g, '')}</code></pre>`;
        });

        // Código en línea `...`
        str = str.replace(/`([^`]+)`/g, '<code class="px-1 py-0.5 rounded bg-black/5 dark:bg-white/10">$1</code>');

        // Negritas e itálicas
        str = str.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        str = str.replace(/\*(.*?)\*/g, '<em>$1</em>');

        // Enlaces [text](url)
        str = str.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-primary-500 hover:underline">$1</a>');

        // IMPORTANTE:
        // No hacemos str.replace(/\n/g,'<br>') para NO romper $$...$$
        // Los saltos se ven por CSS: whitespace-pre-wrap
        return str;
      }
    };
  </script>
</body>
</html>
