<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="stylesheet" href="olap-theme.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q25WGL1GDZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Q25WGL1GDZ');
  </script>
  <link rel="stylesheet" href="responsive.css">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Clicker de Puntos — con Misiones</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#171821; --panel:#1f2230; --panel-2:#24273a; --text:#e9ecf1; --muted:#a8b0c2; --brand:#6ee7ff; --brand-2:#7c4dff; --cta:#ffd166; --danger:#ff6b6b; --ok:#36d399;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background: radial-gradient(1200px 600px at 10% -10%, #2b2e41, transparent), linear-gradient(160deg, #171821 0%, #10111a 100%);color:var(--text);font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

  /* Top bar */
  .topbar{position:fixed;inset:0 auto auto 0;display:flex;gap:.75rem;padding:.75rem;z-index:50}
  .chip{position:relative;background:rgba(255,255,255,.06);backdrop-filter: blur(8px);-webkit-backdrop-filter: blur(8px); color:#fff;border:1px solid rgba(255,255,255,.1);padding:.55rem .9rem;border-radius:999px;font-weight:700;letter-spacing:.6px;box-shadow:var(--shadow);font-family:'Press Start 2P', cursive;font-size:.6rem;transition:transform .12s ease, background .2s}
  .chip:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}

  /* Badge en el botón de misiones */
  .notif-badge{
    position:absolute; top:-6px; right:-6px;
    min-width:18px; height:18px; padding:0 4px;
    background:linear-gradient(180deg,#ef4444,#dc2626);
    border:1px solid rgba(0,0,0,.35);
    border-radius:999px;
    color:#fff; font-family:'Press Start 2P', cursive; font-size:.55rem; line-height:18px; text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,.4);
    display:none;
  }
  .notif-badge.show{display:inline-block}

  /* Layout */
  #game-container{display:grid;grid-template-columns:1fr 360px;gap:18px;height:100vh;padding:72px 18px 18px 18px}
  @media (max-width: 980px){#game-container{grid-template-columns:1fr;grid-auto-rows:minmax(0,1fr)} #upgrades{order:2; height:45vh}}

  /* Farm panel */
  #farm{position:relative;background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);border:1px solid rgba(255,255,255,.08);border-radius:18px;display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr auto;grid-template-areas:'stats main' '. main' 'power main';align-items:center;gap:12px;padding:18px;overflow:hidden;box-shadow:var(--shadow)}
  @media (max-width: 980px){#farm{grid-template-columns:1fr;grid-template-rows:auto auto 1fr;grid-template-areas:'stats' 'power' 'main'}}

  .grid-glow{position:absolute;inset:0;background-image: radial-gradient(circle at 50% 10%, rgba(124,77,255,.25), transparent 40%), radial-gradient(circle at 80% 80%, rgba(110,231,255,.15), transparent 40%);pointer-events:none}

  /* Stats overlay */
  #stats-overlay{grid-area:stats;position:relative;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:.75rem 1rem;border-radius:12px;font-family:'Press Start 2P', cursive;font-size:.8rem;line-height:1.35;text-shadow:0 1px 0 rgba(0,0,0,.4);box-shadow:var(--shadow);min-width:0;max-width:100%}
  #stats-overlay p{margin:6px 0}
  #prestige-row{display:flex;align-items:center;gap:.5rem;margin-top:.25rem}
  .hint{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);font-size:.6rem;cursor:help}

  /* Prestige button */
  #btn-prestige{margin-top:8px;padding:.6rem .9rem;font-family:'Press Start 2P', cursive;font-size:.7rem;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#4b5563,#374151);color:#fff;transition:all .2s;cursor:not-allowed;opacity:.75}
  #btn-prestige.enabled{background: linear-gradient(180deg,#ffb703,#fb8500); color:#10111a; cursor:pointer; opacity:1; box-shadow:0 0 0 3px rgba(251,133,0,.25)}

  /* Main click button */
  #firefly-btn{grid-area:main;background:none;border:none;cursor:pointer;position:relative;z-index:5;border-radius:20px;padding:8px;transition: transform .08s ease;justify-self:center;align-self:center;max-width:100%;width:min(100%,520px)}
  #firefly-btn img{width:clamp(220px,48vw,520px);max-width:100%;height:auto;display:block;filter: drop-shadow(0 6px 24px rgba(0,0,0,.55))}
  #firefly-btn:active{transform:scale(.98)}
  @media (max-width: 980px){#firefly-btn img{width:min(78vw,520px)}}

  /* Power bar */
  #power-wrap{grid-area:power;display:flex;align-items:center;gap:12px;z-index:3}
  #power-bar-container{position:relative;width:28px;height:160px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);border-radius:14px;overflow:hidden;flex-shrink:0}
  #power-bar-fill{position:absolute;bottom:0;left:0;width:100%;height:0%;background:linear-gradient(180deg,#ef4444,#fb7185)}
  #power-badge{display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:.45rem .7rem;border-radius:999px;font-family:'Press Start 2P', cursive;font-size:.75rem}
  #power-dot{width:10px;height:10px;border-radius:50%;background:#999}
  .ready #power-dot{background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,.8)}
  #power-badge.active{background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.35)}
  #power-badge.active #power-dot{background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,.8)}

  /* Floating +text */
  .float-text{position:absolute;font-family:'Press Start 2P', cursive;font-size:1.1rem;color:#9ae6ff;text-shadow:1px 1px 2px #000;pointer-events:none;white-space:nowrap;animation:floatUp 1.2s ease-out forwards;z-index:10}
  @keyframes floatUp{to{opacity:0; transform:translateY(-80px)}}

  /* Upgrades */
  #upgrades{background:rgba(0,0,0,.35);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:14px; overflow:auto; height:calc(100vh - 90px); box-shadow:var(--shadow)}
  #upgrades h2{font-family:'Press Start 2P', cursive;margin:4px 4px 10px 4px;letter-spacing:.5px}
  .upgrade{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); padding:12px; border-radius:12px; margin-bottom:10px; box-shadow:var(--shadow); display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .upgrade .meta{font-family:'Press Start 2P', cursive; font-size:.7rem; color:var(--muted)}
  .badge{display:inline-block;background:rgba(124,77,255,.25);border:1px solid rgba(124,77,255,.55);padding:.2rem .45rem;border-radius:999px;font-size:.6rem;margin-left:.25rem}
  .upgrade button{padding:.55rem .85rem;background:linear-gradient(180deg,#60a5fa,#38bdf8);border:1px solid rgba(255,255,255,.25);border-radius:10px;cursor:pointer;font-weight:800;box-shadow:var(--shadow);transition:filter .2s, transform .05s;color:#0b1020}
  .upgrade button:hover{filter:brightness(1.05)}
  .upgrade button:active{transform:translateY(1px)}
  .upgrade button:disabled{background:linear-gradient(180deg,#4b5563,#374151);color:#cbd5e1;cursor:not-allowed;opacity:.7}

  /* Toast */
  #toast{position:fixed;right:14px;bottom:14px;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.12); color:#fff;padding:.7rem 1rem;border-radius:12px;box-shadow:var(--shadow);font-family:'Press Start 2P', cursive;font-size:.75rem;opacity:0;transform:translateY(10px);transition:all .25s;z-index:90}
  #toast.show{opacity:1;transform:translateY(0)}

  /* Modales genéricos */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{
    display:flex;
    flex-direction:column;
    width:min(760px,92vw);
    background:linear-gradient(180deg, #212537, #1a1d2b);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;box-shadow:var(--shadow);padding:18px;
    max-height:90vh; overflow:hidden;
  }
  .modal h3{font-family:'Press Start 2P', cursive;margin:0 0 12px 0}
  .modal p{color:#d9deea;line-height:1.5;margin:.5rem 0}
  .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.modal .grid{grid-template-columns:1fr}}
  .modal .cta{position:sticky;bottom:0;background: linear-gradient(180deg, rgba(26,29,43,0), rgba(26,29,43,0.85) 40%, #1a1d2b 100%);margin-top:8px;padding-top:8px;display:flex;justify-content:flex-end}
  .btn{padding:.6rem .9rem;border-radius:12px;border:1px solid rgba(255,255,255,.15);font-weight:800;cursor:pointer}
  .btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#081018}
  .btn-ghost{background:transparent;color:#fff}
  .modal-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .close-x{border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);border-radius:10px;padding:.4rem .6rem;cursor:pointer}

  /* Misiones */
  #missions-list{display:grid;gap:10px;margin-top:10px;flex:1;min-height:0;overflow:auto;-webkit-overflow-scrolling:touch;padding-right:4px}
  .mission{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
  .mission h4{margin:0;font-family:'Press Start 2P', cursive;font-size:.8rem;letter-spacing:.3px}
  .mission .muted{color:var(--muted);font-size:.8rem}
  .progress{height:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
  .progress > div{height:100%;width:0%;background:linear-gradient(90deg,#7c4dff,#6ee7ff)}
  .mission .right{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
  .mission .reward{font-family:'Press Start 2P', cursive;font-size:.7rem;background:rgba(255,209,102,.15);border:1px solid rgba(255,209,102,.35);padding:.25rem .5rem;border-radius:999px}
  .mission .diff{font-family:'Press Start 2P', cursive;font-size:.6rem;background:rgba(124,77,255,.2);border:1px solid rgba(124,77,255,.45);padding:.15rem .45rem;border-radius:999px;margin-left:.25rem}
  .mission button{padding:.5rem .8rem;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#081018;font-weight:800;cursor:pointer}
  .mission button:disabled{background:linear-gradient(180deg,#4b5563,#374151);color:#cbd5e1;cursor:not-allowed}
  .mission.done{opacity:.75}
</style>
</head>
<body>

<!-- Top chips -->
<div class="topbar" aria-label="Acciones rápidas">
  <button class="chip" id="open-help" title="Cómo jugar">INFO</button>
  <a href="./index.html" class="chip" title="Volver al menú">MENÚ</a>
  <button class="chip" id="open-missions" title="Ver misiones">
    MISIONES
    <span id="missions-badge" class="notif-badge" aria-hidden="true">0</span>
  </button>
</div>

<div id="game-container">
  <div id="farm" aria-live="polite">
    <div class="grid-glow" aria-hidden="true"></div>

    <div id="stats-overlay" role="status" aria-label="Estadísticas">
      <p>Puntos: <span id="puntos">0</span></p>
      <p>Por clic: <span id="porClic">1</span></p>
      <p>Por segundo: <span id="pps">0</span></p>
      <div id="prestige-row">
        <p id="prestige-mult" style="margin:0">Multiplicador: ×1
      </div>
      <p id="prestige-points">Prestige points: 0</p>
      <button id="btn-prestige" disabled>Prestige</button>
    </div>

    <button id="firefly-btn" aria-label="Ganar puntos con un clic">
      <img id="main-image" src="./img/clicker/nivel0.png" alt="Elemento principal del clicker" />
    </button>

    <div id="power-wrap">
      <div id="power-bar-container" aria-label="Barra de combo">
        <div id="power-bar-fill"></div>
      </div>
      <div id="power-badge"><span id="power-dot"></span> <span id="power-label">Combo ×1</span></div>
    </div>
  </div>

  <aside id="upgrades" aria-label="Mejoras y tienda">
    <h2>Mejoras</h2>
  </aside>
</div>

<div id="toast" role="status" aria-live="polite">¡Prestige disponible!</div>

<!-- Help modal -->
<div class="modal-backdrop" id="help-modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-header">
      <h3 id="help-title">Cómo jugar</h3>
      <button class="close-x" id="close-help-x" aria-label="Cerrar ayuda">✕</button>
    </div>
    <div class="grid">
      <div>
        <p><strong>Haz clic</strong> en el elemento central para ganar puntos. Compra <strong>mejoras</strong> para aumentar los puntos por clic y por segundo.</p>
        <p>La barra vertical carga con cada clic. Al llenarse (y antes de que baje), activa un <strong>Combo ×2</strong> temporal.</p>
      </div>
      <div>
        <p><strong>Prestigio:</strong> al llegar a ciertos umbrales, puedes <em>prestige</em>. Reinicia tu progreso y obtén <strong>Puntos de Prestigio</strong> que dan un multiplicador permanente.</p>
        <p>El juego se <strong>guarda automáticamente</strong> en tu navegador.</p>
      </div>
    </div>
    <div class="cta">
      <button class="btn btn-primary" id="lets-go">¡Vamos!</button>
    </div>
  </div>
</div>

<!-- Missions modal (sin cruz) -->
<div class="modal-backdrop" id="missions-modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="missions-title">
    <div class="modal-header">
      <h3 id="missions-title">Misiones</h3>
    </div>
    <p class="muted">Completa objetivos y reclama <strong>puntos</strong>. Cuanto más difícil, mayor recompensa.</p>
    <div id="missions-list" aria-live="polite"></div>
    <div class="cta">
      <button class="btn btn-primary" id="close-missions">Cerrar</button>
    </div>
  </div>
</div>

<script>
// ——— Datos de mejoras ———
const rawBaseInfo = [
  ['Mini generador', 10, 'pps', 1, 'mini'],
  ['Colmena de hongos', 50, 'pps', 5, 'hongos'],
  ['Cristal mágico', 100, 'click', 10, 'cristal']
];
const rawExtrasInfo = [
  ['Luz de aurora',500,'pps',10],['Néctar ancestral',1000,'click',10],['Eco estelar',2000,'pps',20],['Aura mística',5000,'click',50],
  ['Corazón de eclipse',10000,'pps',100],['Aura solar',20000,'click',100],['Polvo cósmico',50000,'pps',200],['Gema eterna',100000,'click',500],
  ['Esencia lúgubre',200000,'pps',1000],['Corazón galáctico',500000,'click',1000],['Núcleo de tiempo',1000000,'pps',2000],['Sombra viviente',2000000,'click',2000],
  ['Aliento de cometa',5000000,'pps',5000],['Esfera de vacío',10000000,'click',5000],['Luz infinita',20000000,'pps',10000],['Vórtice de sueños',50000000,'click',10000],
  ['Fragmento de aurora',100000000,'pps',25000],['Pulso ancestral',200000000,'click',25000],['Cúpula estelar',500000000,'pps',50000],['Eco del vacío',1000000000,'click',50000],
  ['Rayo de mañana',2000000000,'pps',100000],['Corazón de nebulosa',5000000000,'click',100000],['Alma de la selva',10000000000,'pps',250000],['Torrente de luz',20000000000,'click',250000],
  ['Resonancia eterna',50000000000,'pps',500000],['Nexus de almas',100000000000,'click',500000],['Horizonte fractal',500000000000,'both',{click:1000000,pps:1000000}]
];

const upgrades = [
  ...rawBaseInfo.map(([label, baseCost, type, bonus, key]) => ({ label, key, baseCost, cost: baseCost, type, bonus, count: 0 })),
  ...rawExtrasInfo.map(([label, baseCost, type, bonus], i) => ({ label, key: `extra${i+1}`, baseCost, cost: baseCost, type, bonus, count: 0 }))
];

// ——— Estado ———
let puntos = 0; let puntosPorClic = 1; let pps = 0; let barValue = 0; let buffActive = false; let buffTimeout; let prestigePoints = 0;
const barIncrease = 6; const barDecayPerSec = 10; const buffDuration = 2000;
const activationThreshold = 95;
let currentImageLevel = 0; const MAX_IMAGE_LEVEL = 30;

// Estadísticas para misiones
let stats = {
  totalClicks: 0,
  totalPurchases: 0,
  comboActivations: 0,
  prestigeCount: 0,
  maxPointsEver: 0
};

// ——— Misiones ———
const missions = [
  // CLICKS
  { id:'click_50',   title:'Calentando dedos',  desc:'Haz 50 clics.', type:'clicks', target:50, difficulty:1, claimed:false },
  { id:'click_200',  title:'Ritmo constante',   desc:'Haz 200 clics.', type:'clicks', target:200, difficulty:1, claimed:false },
  { id:'click_500',  title:'Pulgar de acero',   desc:'Haz 500 clics.', type:'clicks', target:500, difficulty:2, claimed:false },
  { id:'click_2k',   title:'Metrónomo humano',  desc:'Haz 2.000 clics.', type:'clicks', target:2000, difficulty:3, claimed:false },
  { id:'click_10k',  title:'Clickeador épico',  desc:'Haz 10.000 clics.', type:'clicks', target:10000, difficulty:4, claimed:false },
  { id:'click_25k',  title:'Clic infinito',     desc:'Haz 25.000 clics.', type:'clicks', target:25000, difficulty:5, claimed:false },

  // COMBOS
  { id:'combo_5',    title:'Combo rookie',      desc:'Activa 5 combos.', type:'combos', target:5, difficulty:2, claimed:false },
  { id:'combo_15',   title:'Cadena decente',    desc:'Activa 15 combos.', type:'combos', target:15, difficulty:2, claimed:false },
  { id:'combo_25',   title:'Combo maestro',     desc:'Activa 25 combos.', type:'combos', target:25, difficulty:3, claimed:false },
  { id:'combo_60',   title:'Combo leyenda',     desc:'Activa 60 combos.', type:'combos', target:60, difficulty:4, claimed:false },
  { id:'combo_120',  title:'Modo supernova',    desc:'Activa 120 combos.', type:'combos', target:120, difficulty:5, claimed:false },

  // COMPRAS (totales)
  { id:'buy_10',     title:'Comprador ávido',   desc:'Compra 10 mejoras.', type:'purchases', target:10, difficulty:2, claimed:false },
  { id:'buy_30',     title:'Inversionista',     desc:'Compra 30 mejoras.', type:'purchases', target:30, difficulty:3, claimed:false },
  { id:'buy_60',     title:'Ballena casual',    desc:'Compra 60 mejoras.', type:'purchases', target:60, difficulty:4, claimed:false },
  { id:'buy_120',    title:'Ballena espacial',  desc:'Compra 120 mejoras.', type:'purchases', target:120, difficulty:5, claimed:false },

  // COMPRAS (por tipo)
  { id:'buy_mini_5', title:'Mini generador x5', desc:'Compra 5 Mini generadores.', type:'purchases', target:5, difficulty:1, claimed:false, key:'mini' },
  { id:'buy_hong_5', title:'Colmena x5',        desc:'Compra 5 Colmenas de hongos.', type:'purchases', target:5, difficulty:2, claimed:false, key:'hongos' },
  { id:'buy_cris_5', title:'Cristal x5',        desc:'Compra 5 Cristales mágicos.', type:'purchases', target:5, difficulty:2, claimed:false, key:'cristal' },

  // PUNTOS
  { id:'reach_5k',   title:'Cinco mil',         desc:'Alcanza 5.000 puntos.', type:'reach', target:5000, difficulty:1, claimed:false },
  { id:'reach_10k',  title:'Diez mil',          desc:'Alcanza 10.000 puntos.', type:'reach', target:10000, difficulty:2, claimed:false },
  { id:'reach_100k', title:'Cien mil',          desc:'Alcanza 100.000 puntos.', type:'reach', target:100000, difficulty:3, claimed:false },
  { id:'reach_1m',   title:'Millonario',        desc:'Alcanza 1.000.000 de puntos.', type:'reach', target:1_000_000, difficulty:4, claimed:false },
  { id:'reach_100m', title:'Cien millones',     desc:'Alcanza 100.000.000 de puntos.', type:'reach', target:100_000_000, difficulty:5, claimed:false },

  // PRESTIGE
  { id:'prestige_1', title:'Primer prestigio',  desc:'Realiza 1 Prestige.', type:'prestige', target:1, difficulty:5, claimed:false },
  { id:'prestige_3', title:'Trifuerza',         desc:'Realiza 3 Prestiges.', type:'prestige', target:3, difficulty:5, claimed:false }
];

// Recompensas reducidas (1→1.000 | 2→5.000 | 3→20.000 | 4→100.000 | 5→500.000)
function missionReward(difficulty){
  const table = [0, 1000, 5000, 20000, 100000, 500000];
  return table[difficulty] || 1000;
}

// ——— Utilidades UI ———
const fmt = new Intl.NumberFormat('es-ES', { notation: 'compact', maximumFractionDigits: 2 });
function n(v){ return fmt.format(v); }
function setImageLevel(l){ currentImageLevel = Math.min(Math.max(0,l), MAX_IMAGE_LEVEL); document.getElementById('main-image').src = `./img/clicker/nivel${currentImageLevel}.png`; }
function computeCost(b,c){ return Math.floor(b * Math.pow(1.15, c)); }
function recalcPPS(){ pps = upgrades.reduce((s,u)=> s + (u.type==='pps'? u.count*u.bonus : u.type==='both'? u.count*u.bonus.pps : 0), 0); }
function recalcPorClic(){ puntosPorClic = 1 + upgrades.reduce((s,u)=> s + (u.type==='click'? u.count*u.bonus : u.type==='both'? u.count*u.bonus.click : 0), 0); }
function prestigeMultiplier(){ return 1 + prestigePoints * 0.1; }

// Toast
let toastTimer; const toast = document.getElementById('toast');
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(()=> toast.classList.remove('show'), 2000); }

// ——— Badge de misiones ———
const missionsBadgeEl = document.getElementById('missions-badge');
function countClaimables(){
  return missions.filter(m => missionDone(m) && !m.claimed).length;
}
function updateMissionsBadge(){
  const c = countClaimables();
  if (c > 0){
    missionsBadgeEl.textContent = c;
    missionsBadgeEl.classList.add('show');
    missionsBadgeEl.setAttribute('aria-hidden','false');
  } else {
    missionsBadgeEl.classList.remove('show');
    missionsBadgeEl.setAttribute('aria-hidden','true');
  }
}

function updateUI(){
  const t = (buffActive ? 2 : 1) * prestigeMultiplier();
  document.getElementById('puntos').textContent = n(puntos);
  document.getElementById('porClic').textContent = n(puntosPorClic * t);
  document.getElementById('pps').textContent = n(pps * t);
  document.getElementById('prestige-mult').textContent = `Multiplicador: ×${(prestigeMultiplier()).toFixed(2)}`;
  document.getElementById('prestige-points').textContent = `Prestige points: ${n(prestigePoints)}`;
  document.getElementById('power-label').textContent = `Combo ${buffActive? '×2' : '×1'}`;
  const badge = document.getElementById('power-badge');
  badge.classList.toggle('active', buffActive);
  badge.classList.toggle('ready', !buffActive && barValue >= activationThreshold);

  upgrades.forEach(u => {
    const countEl = document.getElementById(`${u.key}-count`);
    const costEl = document.getElementById(`${u.key}-cost`);
    const btn = document.getElementById(`btn-${u.key}`);
    if (countEl) countEl.textContent = n(u.count);
    if (costEl) costEl.textContent = n(u.cost);
    if (btn) btn.disabled = puntos < u.cost;
  });

  const prestigeBtn = document.getElementById('btn-prestige');
  if (puntos >= 1000000){
    if (prestigeBtn.disabled) showToast('¡Prestigio disponible!');
    prestigeBtn.classList.add('enabled'); prestigeBtn.disabled = false;
  } else { prestigeBtn.classList.remove('enabled'); prestigeBtn.disabled = true; }

  // Render + actualizar badge si el modal está abierto o no
  updateMissionsBadge();
  if (missionsModal.style.display === 'flex') renderMissions();
}

function updateBar(){ if (!buffActive){ barValue = Math.max(0, barValue - barDecayPerSec / 10); document.getElementById('power-bar-fill').style.height = barValue + '%'; } }
function startBuff(){
  buffActive = true; document.getElementById('power-label').textContent = 'Combo ×2';
  stats.comboActivations++; saveGame();
  clearTimeout(buffTimeout);
  buffTimeout = setTimeout(()=>{ buffActive = false; document.getElementById('power-label').textContent = 'Combo ×1'; }, buffDuration);
}

function getPrestigeGain(p){
  const thresholds = [ 50000000000, 10000000000, 5000000000, 1000000000, 500000000, 100000000, 50000000, 10000000, 5000000, 1000000 ];
  const gains =      [ 10,           9,           8,          7,          6,          5,          4,          3,         2,         1 ];
  for (let i=0;i<thresholds.length;i++){ if (p >= thresholds[i]) return gains[i]; }
  return 0;
}

function attemptPrestige(){
  const gained = getPrestigeGain(puntos); if (!gained) return;
  if(!confirm(`¿Prestige ahora y ganar ${gained} puntos de prestigio?`)) return;
  prestigePoints += gained; stats.prestigeCount++;
  puntos = 0; puntosPorClic = 1;
  upgrades.forEach(u=>{ u.count=0; u.cost=u.baseCost; });
  recalcPPS(); recalcPorClic(); setImageLevel(0); updateUI(); saveGame();
}

// —— Guardado —— 
function saveGame(){
  localStorage.setItem('clickerGame', JSON.stringify({
    puntos, puntosPorClic, upgrades, prestigePoints, currentImageLevel, stats, missions
  }));
}
function loadGame(){
  const s = JSON.parse(localStorage.getItem('clickerGame')); if(!s) return;
  puntos=s.puntos; puntosPorClic=s.puntosPorClic;
  if(s.upgrades){ s.upgrades.forEach(saved=>{ const u=upgrades.find(x=>x.key===saved.key); if(u) Object.assign(u, saved); }); }
  prestigePoints=s.prestigePoints; currentImageLevel=s.currentImageLevel||0; stats = Object.assign(stats, s.stats||{});
  if (Array.isArray(s.missions)){
    missions.forEach(m=>{
      const found = s.missions.find(x=>x.id===m.id);
      if (found) { m.claimed = !!found.claimed; }
    });
  }
  setImageLevel(currentImageLevel); recalcPPS(); recalcPorClic();
}

// ——— Construcción del DOM de mejoras ———
const upgContainer = document.getElementById('upgrades');
upgrades.forEach(u => {
  const d = document.createElement('div'); d.className='upgrade';
  let bonusText = (u.type === 'pps') ? `+${n(u.bonus)} por segundo`
                 : (u.type === 'click') ? `+${n(u.bonus)} por clic`
                 : `+${n(u.bonus.click)} por clic y +${n(u.bonus.pps)} por segundo`;
  d.innerHTML = `
    <div>
      <div style="display:flex;align-items:center;gap:.35rem;flex-wrap:wrap">
        <strong>${u.label}</strong>
      </div>
      <div class="meta">Cantidad: <span id="${u.key}-count">0</span></div>
      <div class="meta">${bonusText}</div>
      <div class="meta">Coste: <span id="${u.key}-cost">${n(u.cost)}</span></div>
    </div>
    <div>
      <button id="btn-${u.key}">Comprar</button>
    </div>`;
  upgContainer.appendChild(d);
  document.getElementById(`btn-${u.key}`).onclick = () => {
    if (puntos >= u.cost){
      puntos -= u.cost; u.count++; stats.totalPurchases++;
      if (u.count === 1) setImageLevel(currentImageLevel + 1);
      if (u.type !== 'pps') recalcPorClic();
      if (u.type !== 'click') recalcPPS();
      u.cost = computeCost(u.baseCost, u.count);
      recalcPPS(); recalcPorClic(); updateUI(); saveGame();
    }
  };
});

// ——— Misiones: lógica y UI ———
const missionsList = document.getElementById('missions-list');

function missionProgress(m){
  switch(m.type){
    case 'clicks':    return Math.min(stats.totalClicks, m.target);
    case 'purchases':
      if (m.key){
        const upg = upgrades.find(u=>u.key===m.key);
        return Math.min(upg ? upg.count : 0, m.target);
      }
      return Math.min(stats.totalPurchases, m.target);
    case 'combos':    return Math.min(stats.comboActivations, m.target);
    case 'prestige':  return Math.min(stats.prestigeCount, m.target);
    case 'reach':     return Math.min(stats.maxPointsEver, m.target);
    default: return 0;
  }
}
function missionDone(m){ return missionProgress(m) >= m.target; }

function renderMissions(){
  if (!missionsList) return;
  missionsList.innerHTML = '';
  missions.forEach(m=>{
    const progress = missionProgress(m);
    const pct = Math.min(100, Math.floor((progress / m.target) * 100));
    const reward = missionReward(m.difficulty);
    const item = document.createElement('div');
    item.className = 'mission' + (m.claimed ? ' done' : '');
    item.innerHTML = `
      <div>
        <h4>${m.title} <span class="diff">Dif. ${m.difficulty}</span></h4>
        <p class="muted">${m.desc}</p>
        <div class="progress" aria-label="Progreso ${pct}%"><div style="width:${pct}%"></div></div>
        <p class="muted" aria-live="polite">${n(progress)} / ${n(m.target)}</p>
      </div>
      <div class="right">
        <div class="reward">Recompensa: +${n(reward)}</div>
        <button id="claim-${m.id}" ${(!missionDone(m) || m.claimed) ? 'disabled' : ''}>${m.claimed ? 'Reclamada' : 'Reclamar'}</button>
      </div>
    `;
    missionsList.appendChild(item);
    const btn = item.querySelector(`#claim-${m.id}`);
    btn && (btn.onclick = ()=>{
      if (missionDone(m) && !m.claimed){
        puntos += reward;
        m.claimed = true;
        showToast(`¡Misión completada! +${n(reward)} puntos`);
        updateUI(); saveGame();
      }
    });
  });
  // Actualizar badge tras render
  updateMissionsBadge();
}

// ——— Eventos ———
const farmEl = document.getElementById('farm');

document.getElementById('firefly-btn').addEventListener('click', e => {
  if (barValue >= activationThreshold && !buffActive) startBuff();
  const g = puntosPorClic * (buffActive ? 2 : 1) * prestigeMultiplier();
  puntos += g; barValue = Math.min(barValue + barIncrease, 100);
  stats.totalClicks++;
  stats.maxPointsEver = Math.max(stats.maxPointsEver, Math.floor(puntos));
  document.getElementById('power-bar-fill').style.height = barValue + '%';
  const r = farmEl.getBoundingClientRect(); const s = document.createElement('span'); s.className='float-text'; s.textContent = '+' + n(g);
  s.style.left = (e.clientX - r.left) + 'px'; s.style.top = (e.clientY - r.top) + 'px'; farmEl.appendChild(s); s.addEventListener('animationend', ()=> s.remove());
  updateUI(); saveGame();
});

document.getElementById('btn-prestige').onclick = attemptPrestige;

setInterval(updateBar, 100);
setInterval(()=>{
  puntos += pps * (buffActive ? 2 : 1) * prestigeMultiplier();
  stats.maxPointsEver = Math.max(stats.maxPointsEver, Math.floor(puntos));
  updateUI(); saveGame();
}, 1000);

// ——— Help modal logic ———
const helpModal = document.getElementById('help-modal');
const openHelp = () => { helpModal.style.display='flex'; document.body.style.overflow='hidden'; helpModal.setAttribute('aria-hidden','false'); };
const closeHelp = () => { helpModal.style.display='none'; document.body.style.overflow=''; helpModal.setAttribute('aria-hidden','true'); };

document.getElementById('open-help').addEventListener('click', openHelp);
document.getElementById('close-help-x').addEventListener('click', closeHelp);
document.getElementById('lets-go').addEventListener('click', closeHelp);

// ——— Missions modal logic ———
const missionsModal = document.getElementById('missions-modal');
const openMissions = () => {
  missionsModal.style.display='flex';
  missionsModal.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  renderMissions();
};
const closeMissions = () => {
  missionsModal.style.display='none';
  missionsModal.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  // Al cerrar, seguimos mostrando el badge si queda algo por reclamar
  updateMissionsBadge();
};

document.getElementById('open-missions').addEventListener('click', openMissions);
document.getElementById('close-missions').addEventListener('click', closeMissions);

// Cerrar con clic fuera del cuadro (backdrop)
[helpModal, missionsModal].forEach(backdrop=>{
  backdrop.addEventListener('click', (e)=>{
    if (e.target === backdrop){
      if (backdrop === missionsModal) closeMissions();
      else closeHelp();
    }
  });
});

// Cerrar con tecla ESC
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape'){
    if (missionsModal.style.display === 'flex') closeMissions();
    if (helpModal.style.display === 'flex') closeHelp();
  }
});

// ——— Inicialización ———
loadGame(); recalcPPS(); recalcPorClic(); updateUI(); setImageLevel(currentImageLevel);

// Mostrar ayuda solo la primera vez
if (!localStorage.getItem('clicker_seen_help')){ openHelp(); localStorage.setItem('clicker_seen_help','1'); }
</script>
  <script src="touch-controls.js"></script>
</body>
</html>
