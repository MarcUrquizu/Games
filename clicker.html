<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Clicker de Puntos — versión pulida (layout fijo)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#171821; --panel:#1f2230; --panel-2:#24273a; --text:#e9ecf1; --muted:#a8b0c2; --brand:#6ee7ff; --brand-2:#7c4dff; --cta:#ffd166; --danger:#ff6b6b; --ok:#36d399;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background: radial-gradient(1200px 600px at 10% -10%, #2b2e41, transparent), linear-gradient(160deg, #171821 0%, #10111a 100%);color:var(--text);font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

  /* Top bar */
  .topbar{position:fixed;inset:0 auto auto 0;display:flex;gap:.75rem;padding:.75rem;z-index:50}
  .chip{background:rgba(255,255,255,.06);backdrop-filter: blur(8px);-webkit-backdrop-filter: blur(8px); color:#fff;border:1px solid rgba(255,255,255,.1);padding:.55rem .9rem;border-radius:999px;font-weight:700;letter-spacing:.6px;box-shadow:var(--shadow);font-family:'Press Start 2P', cursive;font-size:.6rem;transition:transform .12s ease, background .2s}
  .chip:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}

  /* Layout */
  #game-container{display:grid;grid-template-columns:1fr 360px;gap:18px;height:100vh;padding:72px 18px 18px 18px}
  @media (max-width: 980px){#game-container{grid-template-columns:1fr;grid-auto-rows:minmax(0,1fr)} #upgrades{order:2; height:45vh}}

  /* Farm panel (GRID para evitar superposiciones) */
  #farm{position:relative;background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);border:1px solid rgba(255,255,255,.08);border-radius:18px;display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr auto;grid-template-areas:'stats main' '. main' 'power main';align-items:center;gap:12px;padding:18px;overflow:hidden;box-shadow:var(--shadow)}
  @media (max-width: 980px){#farm{grid-template-columns:1fr;grid-template-rows:auto auto 1fr;grid-template-areas:'stats' 'power' 'main'}}

  .grid-glow{position:absolute;inset:0;background-image: radial-gradient(circle at 50% 10%, rgba(124,77,255,.25), transparent 40%), radial-gradient(circle at 80% 80%, rgba(110,231,255,.15), transparent 40%);pointer-events:none}

  /* Stats overlay */
  #stats-overlay{grid-area:stats;position:relative;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:.75rem 1rem;border-radius:12px;font-family:'Press Start 2P', cursive;font-size:.8rem;line-height:1.35;text-shadow:0 1px 0 rgba(0,0,0,.4);box-shadow:var(--shadow);min-width:0;max-width:100%}
  #stats-overlay p{margin:6px 0}
  #prestige-row{display:flex;align-items:center;gap:.5rem;margin-top:.25rem}
  .hint{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);font-size:.6rem;cursor:help}

  /* Prestige button */
  #btn-prestige{margin-top:8px;padding:.6rem .9rem;font-family:'Press Start 2P', cursive;font-size:.7rem;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#4b5563,#374151);color:#fff;transition:all .2s;cursor:not-allowed;opacity:.75}
  #btn-prestige.enabled{background: linear-gradient(180deg,#ffb703,#fb8500); color:#10111a; cursor:pointer; opacity:1; box-shadow:0 0 0 3px rgba(251,133,0,.25)}

  /* Main click button */
  #firefly-btn{grid-area:main;background:none;border:none;cursor:pointer;position:relative;z-index:5;border-radius:20px;padding:8px;transition: transform .08s ease;justify-self:center;align-self:center;max-width:100%;width:min(100%,520px)}
  #firefly-btn img{width:clamp(220px,48vw,520px);max-width:100%;height:auto;display:block;filter: drop-shadow(0 6px 24px rgba(0,0,0,.55))}
  #firefly-btn:active{transform:scale(.98)}
  @media (max-width: 980px){#firefly-btn img{width:min(78vw,520px)}}

  /* Power bar */
  #power-wrap{grid-area:power;display:flex;align-items:center;gap:12px;z-index:3}
  #power-bar-container{position:relative;width:28px;height:160px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);border-radius:14px;overflow:hidden;flex-shrink:0}
  #power-bar-fill{position:absolute;bottom:0;left:0;width:100%;height:0%;background:linear-gradient(180deg,#ef4444,#fb7185)}
  #power-badge{display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:.45rem .7rem;border-radius:999px;font-family:'Press Start 2P', cursive;font-size:.75rem}
  #power-dot{width:10px;height:10px;border-radius:50%;background:#999}
  .ready #power-dot{background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,.8)}
  #power-badge.active{background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.35)}
  #power-badge.active #power-dot{background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,.8)}

  /* Floating +text */
  .float-text{position:absolute;font-family:'Press Start 2P', cursive;font-size:1.1rem;color:#9ae6ff;text-shadow:1px 1px 2px #000;pointer-events:none;white-space:nowrap;animation:floatUp 1.2s ease-out forwards;z-index:10}
  @keyframes floatUp{to{opacity:0; transform:translateY(-80px)}}

  /* Upgrades */
  #upgrades{background:rgba(0,0,0,.35);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:14px; overflow:auto; height:calc(100vh - 90px); box-shadow:var(--shadow)}
  #upgrades h2{font-family:'Press Start 2P', cursive;margin:4px 4px 10px 4px;letter-spacing:.5px}
  .upgrade{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); padding:12px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 10px rgba(0,0,0,.25); display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .upgrade .meta{font-family:'Press Start 2P', cursive; font-size:.7rem; color:var(--muted)}
  .badge{display:inline-block;background:rgba(124,77,255,.25);border:1px solid rgba(124,77,255,.55);padding:.2rem .45rem;border-radius:999px;font-size:.6rem;margin-left:.25rem}
  .upgrade button{padding:.55rem .85rem;background:linear-gradient(180deg,#60a5fa,#38bdf8);border:1px solid rgba(255,255,255,.25);border-radius:10px;cursor:pointer;font-weight:800;box-shadow:var(--shadow);transition:filter .2s, transform .05s;color:#0b1020}
  .upgrade button:hover{filter:brightness(1.05)}
  .upgrade button:active{transform:translateY(1px)}
  .upgrade button:disabled{background:linear-gradient(180deg,#4b5563,#374151);color:#cbd5e1;cursor:not-allowed;opacity:.7}

  /* Toast */
  #toast{position:fixed;right:14px;bottom:14px;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.12); color:#fff;padding:.7rem 1rem;border-radius:12px;box-shadow:var(--shadow);font-family:'Press Start 2P', cursive;font-size:.75rem;opacity:0;transform:translateY(10px);transition:all .25s;z-index:60}
  #toast.show{opacity:1;transform:translateY(0)}

  /* Modal help */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{width:min(680px,92vw);background:linear-gradient(180deg, #212537, #1a1d2b);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:var(--shadow);padding:18px}
  .modal h3{font-family:'Press Start 2P', cursive;margin:0 0 12px 0}
  .modal p{color:#d9deea;line-height:1.5;margin:.5rem 0}
  .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.modal .grid{grid-template-columns:1fr}}
  .modal .cta{display:flex;justify-content:flex-end;margin-top:12px}
  .btn{padding:.6rem .9rem;border-radius:12px;border:1px solid rgba(255,255,255,.15);font-weight:800;cursor:pointer}
  .btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#081018}
  .btn-ghost{background:transparent;color:#fff}
</style>
</head>
<body>

<!-- Top chips -->
<div class="topbar" aria-label="Acciones rápidas">
  <button class="chip" id="open-help" title="Cómo jugar">INFO</button>
  <a href="./index.html" class="chip" title="Volver al menú">MENÚ</a>
</div>

<div id="game-container">
  <div id="farm" aria-live="polite">
    <div class="grid-glow" aria-hidden="true"></div>

    <div id="stats-overlay" role="status" aria-label="Estadísticas">
      <p>Puntos: <span id="puntos">0</span></p>
      <p>Por clic: <span id="porClic">1</span></p>
      <p>Por segundo: <span id="pps">0</span></p>
      <div id="prestige-row">
        <p id="prestige-mult" style="margin:0">Multiplicador: ×1
      </div>
      <p id="prestige-points">Prestige points: 0</p>
      <button id="btn-prestige" disabled>Prestige</button>
    </div>

    <button id="firefly-btn" aria-label="Ganar puntos con un clic">
      <img id="main-image" src="./img/clicker/nivel0.png" alt="Elemento principal del clicker" />
    </button>

    <div id="power-wrap">
      <div id="power-bar-container" aria-label="Barra de combo">
        <div id="power-bar-fill"></div>
      </div>
      <div id="power-badge"><span id="power-dot"></span> <span id="power-label">Combo ×1</span></div>
    </div>
  </div>

  <aside id="upgrades" aria-label="Mejoras y tienda">
    <h2>Mejoras</h2>
  </aside>
</div>

<div id="toast" role="status" aria-live="polite">¡Prestige disponible!</div>

<!-- Help modal -->
<div class="modal-backdrop" id="help-modal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <h3 id="help-title">Cómo jugar</h3>
    <div class="grid">
      <div>
        <p><strong>Haz clic</strong> en el elemento central para ganar puntos. Compra <strong>mejoras</strong> para aumentar los puntos por clic y por segundo.</p>
        <p>La barra vertical carga con cada clic. Al llenarse (y antes de que baje), activa un <strong>Combo ×2</strong> temporal.</p>
      </div>
      <div>
        <p><strong>Prestigio:</strong> al llegar a ciertos umbrales, puedes <em>prestige</em>. Reinicia tu progreso y obtén <strong>Puntos de Prestigio</strong> que dan un multiplicador permanente.</p>
        <p>El juego se <strong>guarda automáticamente</strong> en tu navegador.</p>
      </div>
    </div>
    <div class="cta">
      <button class="btn btn-primary" id="lets-go">¡Vamos!</button>
    </div>
  </div>
</div>

<script>
// ——— Datos de mejoras ———
const rawBaseInfo = [
  ['Mini generador', 10, 'pps', 1, 'mini'],
  ['Colmena de hongos', 50, 'pps', 5, 'hongos'],
  ['Cristal mágico', 100, 'click', 10, 'cristal']
];
const rawExtrasInfo = [
  ['Luz de aurora',500,'pps',10],['Néctar ancestral',1000,'click',10],['Eco estelar',2000,'pps',20],['Aura mística',5000,'click',50],
  ['Corazón de eclipse',10000,'pps',100],['Aura solar',20000,'click',100],['Polvo cósmico',50000,'pps',200],['Gema eterna',100000,'click',500],
  ['Esencia lúgubre',200000,'pps',1000],['Corazón galáctico',500000,'click',1000],['Núcleo de tiempo',1000000,'pps',2000],['Sombra viviente',2000000,'click',2000],
  ['Aliento de cometa',5000000,'pps',5000],['Esfera de vacío',10000000,'click',5000],['Luz infinita',20000000,'pps',10000],['Vórtice de sueños',50000000,'click',10000],
  ['Fragmento de aurora',100000000,'pps',25000],['Pulso ancestral',200000000,'click',25000],['Cúpula estelar',500000000,'pps',50000],['Eco del vacío',1000000000,'click',50000],
  ['Rayo de mañana',2000000000,'pps',100000],['Corazón de nebulosa',5000000000,'click',100000],['Alma de la selva',10000000000,'pps',250000],['Torrente de luz',20000000000,'click',250000],
  ['Resonancia eterna',50000000000,'pps',500000],['Nexus de almas',100000000000,'click',500000],['Horizonte fractal',500000000000,'both',{click:1000000,pps:1000000}]
];

const upgrades = [
  ...rawBaseInfo.map(([label, baseCost, type, bonus, key]) => ({ label, key, baseCost, cost: baseCost, type, bonus, count: 0 })),
  ...rawExtrasInfo.map(([label, baseCost, type, bonus], i) => ({ label, key: `extra${i+1}`, baseCost, cost: baseCost, type, bonus, count: 0 }))
];

// ——— Estado ———
let puntos = 0; let puntosPorClic = 1; let pps = 0; let barValue = 0; let buffActive = false; let buffTimeout; let prestigePoints = 0;
const barIncrease = 6; const barDecayPerSec = 10; const buffDuration = 2000; // vuelta al tiempo original del ×2 // duración del combo ×2 (ms), antes 2000
const activationThreshold = 95;
let currentImageLevel = 0; const MAX_IMAGE_LEVEL = 30;

// ——— Utilidades UI ———
const fmt = new Intl.NumberFormat('es-ES', { notation: 'compact', maximumFractionDigits: 2 });
function n(v){ return fmt.format(v); }
function setImageLevel(l){ currentImageLevel = Math.min(Math.max(0,l), MAX_IMAGE_LEVEL); document.getElementById('main-image').src = `./img/clicker/nivel${currentImageLevel}.png`; }
function computeCost(b,c){ return Math.floor(b * Math.pow(1.15, c)); }
function recalcPPS(){ pps = upgrades.reduce((s,u)=> s + (u.type==='pps'? u.count*u.bonus : u.type==='both'? u.count*u.bonus.pps : 0), 0); }
function recalcPorClic(){ puntosPorClic = 1 + upgrades.reduce((s,u)=> s + (u.type==='click'? u.count*u.bonus : u.type==='both'? u.count*u.bonus.click : 0), 0); }
function prestigeMultiplier(){ return 1 + prestigePoints * 0.1; }

// Toast
let toastTimer; const toast = document.getElementById('toast');
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(()=> toast.classList.remove('show'), 2000); }

function updateUI(){
  const t = (buffActive ? 2 : 1) * prestigeMultiplier();
  document.getElementById('puntos').textContent = n(puntos);
  document.getElementById('porClic').textContent = n(puntosPorClic * t);
  document.getElementById('pps').textContent = n(pps * t);
  document.getElementById('prestige-mult').textContent = `Multiplicador: ×${(prestigeMultiplier()).toFixed(2)}`;
  document.getElementById('prestige-points').textContent = `Prestige points: ${n(prestigePoints)}`;
  document.getElementById('power-label').textContent = `Combo ${buffActive? '×2' : '×1'}`;
  const badge = document.getElementById('power-badge');
  badge.classList.toggle('active', buffActive);
  badge.classList.toggle('ready', !buffActive && barValue >= activationThreshold);

  upgrades.forEach(u => {
    const countEl = document.getElementById(`${u.key}-count`);
    const costEl = document.getElementById(`${u.key}-cost`);
    const btn = document.getElementById(`btn-${u.key}`);
    if (countEl) countEl.textContent = n(u.count);
    if (costEl) costEl.textContent = n(u.cost);
    if (btn) btn.disabled = puntos < u.cost;
  });

  const prestigeBtn = document.getElementById('btn-prestige');
  if (puntos >= 1000000){
    if (prestigeBtn.disabled) showToast('¡Prestigio disponible!');
    prestigeBtn.classList.add('enabled'); prestigeBtn.disabled = false;
  } else { prestigeBtn.classList.remove('enabled'); prestigeBtn.disabled = true; }
}

function updateBar(){ if (!buffActive){ barValue = Math.max(0, barValue - barDecayPerSec / 10); document.getElementById('power-bar-fill').style.height = barValue + '%'; } }
function startBuff(){
  buffActive = true; document.getElementById('power-label').textContent = 'Combo ×2';
  clearTimeout(buffTimeout);
  buffTimeout = setTimeout(()=>{ buffActive = false; document.getElementById('power-label').textContent = 'Combo ×1'; }, buffDuration);
}

function getPrestigeGain(p){
  const thresholds = [ 50000000000, 10000000000, 5000000000, 1000000000, 500000000, 100000000, 50000000, 10000000, 5000000, 1000000 ];
  const gains =      [ 10,           9,           8,          7,          6,          5,          4,          3,         2,         1 ];
  for (let i=0;i<thresholds.length;i++){ if (p >= thresholds[i]) return gains[i]; }
  return 0;
}

function attemptPrestige(){
  const gained = getPrestigeGain(puntos); if (!gained) return;
  if(!confirm(`¿Prestige ahora y ganar ${gained} puntos de prestigio?`)) return;
  prestigePoints += gained; puntos = 0; puntosPorClic = 1; upgrades.forEach(u=>{ u.count=0; u.cost=u.baseCost; });
  recalcPPS(); recalcPorClic(); setImageLevel(0); updateUI(); saveGame();
}

function saveGame(){ localStorage.setItem('clickerGame', JSON.stringify({ puntos, puntosPorClic, upgrades, prestigePoints, currentImageLevel })); }
function loadGame(){ const s = JSON.parse(localStorage.getItem('clickerGame')); if(!s) return; puntos=s.puntos; puntosPorClic=s.puntosPorClic; if(s.upgrades){ s.upgrades.forEach(saved=>{ const u=upgrades.find(x=>x.key===saved.key); if(u) Object.assign(u, saved); }); } prestigePoints=s.prestigePoints; currentImageLevel=s.currentImageLevel||0; setImageLevel(currentImageLevel); recalcPPS(); recalcPorClic(); }

// ——— Construcción del DOM de mejoras ———
const upgContainer = document.getElementById('upgrades');
upgrades.forEach(u => {
  const d = document.createElement('div'); d.className='upgrade';  let bonusText = (u.type === 'pps') ? `+${n(u.bonus)} por segundo` : (u.type === 'click') ? `+${n(u.bonus)} por clic` : `+${n(u.bonus.click)} por clic y +${n(u.bonus.pps)} por segundo`;
  d.innerHTML = `
    <div>
      <div style="display:flex;align-items:center;gap:.35rem;flex-wrap:wrap">
        <strong>${u.label}</strong>
      </div>
      <div class="meta">Cantidad: <span id="${u.key}-count">0</span></div>
      <div class="meta">${bonusText}</div>
      <div class="meta">Coste: <span id="${u.key}-cost">${n(u.cost)}</span></div>
    </div>
    <div>
      <button id="btn-${u.key}">Comprar</button>
    </div>`;
  upgContainer.appendChild(d);
  document.getElementById(`btn-${u.key}`).onclick = () => {
    if (puntos >= u.cost){
      puntos -= u.cost; u.count++;
      if (u.count === 1) setImageLevel(currentImageLevel + 1);
      if (u.type !== 'pps') recalcPorClic(); if (u.type !== 'click') recalcPPS();
      u.cost = computeCost(u.baseCost, u.count);
      recalcPPS(); recalcPorClic(); updateUI(); saveGame();
    }
  };
});

// ——— Eventos ———
const farmEl = document.getElementById('farm');

document.getElementById('firefly-btn').addEventListener('click', e => {
  if (barValue >= activationThreshold && !buffActive) startBuff();
  const g = puntosPorClic * (buffActive ? 2 : 1) * prestigeMultiplier();
  puntos += g; barValue = Math.min(barValue + barIncrease, 100);
  document.getElementById('power-bar-fill').style.height = barValue + '%';
  const r = farmEl.getBoundingClientRect(); const s = document.createElement('span'); s.className='float-text'; s.textContent = '+' + n(g);
  s.style.left = (e.clientX - r.left) + 'px'; s.style.top = (e.clientY - r.top) + 'px'; farmEl.appendChild(s); s.addEventListener('animationend', ()=> s.remove());
  updateUI(); saveGame();
});

document.getElementById('btn-prestige').onclick = attemptPrestige;

setInterval(updateBar, 100);
setInterval(()=>{ puntos += pps * (buffActive ? 2 : 1) * prestigeMultiplier(); updateUI(); saveGame(); }, 1000);

// ——— Help modal logic ———
const helpModal = document.getElementById('help-modal');
const openHelp = () => { helpModal.style.display='flex'; };
const closeHelp = () => { helpModal.style.display='none'; };

document.getElementById('open-help').addEventListener('click', openHelp);
['lets-go'].forEach(id => document.getElementById(id).addEventListener('click', closeHelp));

// ——— Inicialización ———
loadGame(); recalcPPS(); recalcPorClic(); updateUI(); setImageLevel(currentImageLevel);

// Mostrar ayuda solo la primera vez
if (!localStorage.getItem('clicker_seen_help')){ openHelp(); localStorage.setItem('clicker_seen_help','1'); }
</script>
</body>
</html>
