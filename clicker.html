<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Clicker de Puntos</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
<style>
  html, body {
    touch-action: manipulation;
    height: 100%;
    margin: 0;
    overflow: hidden;
    background: #1f1f27;
    color: #fff;
    font-family: 'Montserrat', sans-serif;
  }
  .top-left-buttons {
    position: absolute;
    top: 10px;
    left: 10px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    z-index: 50;
  }
  .game-buttons {
    background-color: rgba(0,0,0,0.8);
    color: #ffffff;
    font-weight: bold;
    text-decoration: none;
    padding: 8px 14px;
    border-radius: 6px;
    font-family: 'Press Start 2P', cursive;
    font-size: 0.65rem;
    letter-spacing: 1px;
    box-shadow: 0 2px 6px rgba(0,0,0,.5);
    transition: background .2s;
    display: inline-block;
    white-space: nowrap;
  }
  .game-buttons:hover { background-color: rgba(255,255,255,0.1); }
  #game-container { display: flex; height: 100%; }
  #farm {
    flex: 1;
    position: relative;
    background: #282c34;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  #stats-overlay {
    position: absolute;
    top: 10px;
    left: 100px;
    background: rgba(0,0,0,.7);
    padding: .5rem 1rem;
    border-radius: 6px;
    font-family: 'Press Start 2P', cursive;
    text-shadow: 1px 1px 2px #000;
    z-index: 10;
    font-size: 0.9rem;
    min-width: 160px;
    cursor: grab;
  }
  #stats-overlay:active { cursor: grabbing; }
  #stats-overlay p { margin: 4px 0; line-height: 1.2; }
  /* Botón de clic ocupa todo el área oscura */
  #firefly-btn {
    position: absolute;
    inset: 0;
    background: none;
    border: none;
    cursor: pointer;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  /* Punto intermedio: 90% tamaño, centrado */
  #firefly-btn img {
    width: 110%;
    height: 110%;
    object-fit: contain;
    transition: transform .1s;
    display: block;
  }
  #firefly-btn img:active { transform: scale(.98); }
  #power-bar-container {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    width: 6vw;
    max-width: 30px;
    height: 25vh;
    max-height: 200px;
    background: rgba(255,255,255,.1);
    border: 2px solid #aaa;
    border-radius: 15px;
    overflow: visible;
    z-index: 5;
  }
  #power-bar-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 0%;
    background: #e74c3c;
    transition: height .1s linear;
    border-bottom-left-radius: 13px;
    border-bottom-right-radius: 13px;
  }
  #power-bar-circle {
    position: absolute;
    top: -20%;
    left: 50%;
    transform: translateX(-50%);
    width: 10vw;
    max-width: 50px;
    height: 10vw;
    max-height: 50px;
    background: #555;
    border: 3px solid #777;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Press Start 2P', cursive;
    font-size: 1rem;
    color: #fff;
    opacity: .25;
    transition: opacity .3s, box-shadow .3s, background .3s;
    z-index: 6;
  }
  #power-bar-circle.active {
    opacity: 1;
    background: #ffeb3b;
    color: #000;
    box-shadow: 0 0 8px rgba(255,235,59,.8);
  }
  .float-text {
    position: absolute;
    font-family:'Press Start 2P', cursive;
    font-size: 1.2rem;
    color: #00eaff;
    text-shadow: 1px 1px 2px #000;
    pointer-events: none;
    animation: floatUp 1.2s ease-out forwards;
    z-index: 10;
  }
  @keyframes floatUp {
    to { opacity: 0; transform: translateY(-80px); }
  }
  #upgrades {
    width: 30vw;
    max-width: 450px;
    flex-shrink: 0;
    background: #fff;
    padding: 1rem;
    box-sizing: border-box;
    overflow-y: auto;
    color: #000;
  }
  #upgrades h2 { font-family: 'Press Start 2P', cursive; margin: 0 0 1rem; }
  .upgrade {
    background: #fff;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,.2);
  }
  .upgrade p { margin: .3rem 0; font-family: 'Press Start 2P', cursive; }
  .upgrade button {
    padding: .5rem 1rem;
    background: #61dafb;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background .2s;
    box-shadow: 0 2px 5px rgba(0,0,0,.2);
    color: #000;
  }
  .upgrade button:hover:not(:disabled) { background: #21a1f1; }
  .upgrade button:disabled { background: #bbb; cursor: not-allowed; }
  @media (max-width: 900px) {
    #game-container { flex-direction: column; }
    #upgrades { width: 100%; max-height: 40vh; overflow-y: scroll; }
    #farm { height: 60vh; }
  }
</style>
</head>
<body>

<div class="top-left-buttons">
  <a href="./help.html" class="game-buttons">INFO</a>
  <a href="./index.html" class="game-buttons">MENU</a>
</div>

<div id="game-container">
  <div id="farm">
    <div id="stats-overlay">
      <p>Puntos: <span id="puntos">0.00</span></p>
      <p>Por clic: <span id="porClic">1.00</span></p>
      <p>Por segundo: <span id="pps">0.00</span></p>
      <p id="prestige-mult">Multiplicador: ×1.00</p>
      <p id="prestige-points">Prestige points: 0</span></p>
      <button id="btn-prestige-inline" disabled>Prestige</button>
    </div>
    <button id="firefly-btn">
      <img id="main-image" src="./img/clicker/nivel0.png" alt="Nivel 0" />
    </button>
    <div id="power-bar-container">
      <div id="power-bar-fill"></div>
      <div id="power-bar-circle"><span id="power-bar-icon">×1</span></div>
    </div>
  </div>
  <div id="upgrades">
    <h2>Mejoras</h2>
    <div class="upgrade" id="upgrade-mini">
      <p>Mini generador: <span id="mini-count">0</span></p>
      <p>Coste: <span id="mini-cost">10</span></p>
      <p>+1 por segundo</p>
      <button id="btn-mini">Comprar</button>
    </div>
    <div class="upgrade" id="upgrade-hongos">
      <p>Colmena de hongos: <span id="hongo-count">0</span></p>
      <p>Coste: <span id="hongo-cost">100</span></p>
      <p>+5 por segundo</p>
      <button id="btn-hongo">Comprar</button>
    </div>
    <div class="upgrade" id="upgrade-cristal">
      <p>Cristal mágico: <span id="cristal-count">0</span></p>
      <p>Coste: <span id="cristal-cost">500</span></p>
      <p>+10 por clic</p>
      <button id="btn-cristal">Comprar</button>
    </div>
    <div id="prestige-container" style="display:none;">
      <p><strong>Prestige</strong>: reinicia todo y obtienes puntos extra.</p>
      <button id="btn-prestige" disabled>Prestige</button>
    </div>
  </div>
</div>

<script>
// ---------- constantes y datos base ----------
const STORAGE_KEY = "clickerState";
const barIncrease = 6;
const barDecayPerSec = 10;
const buffDuration = 2000; // ms
const activationThreshold = 95;

const rawExtrasInfo = [
  ['Luz de aurora', 5000, 'pps', 20],
  ['Néctar ancestral', 10000, 'click', 50],
  ['Eco estelar', 20000, 'pps', 200],
  ['Aura mística', 50000, 'click', 500],
  ['Corazón de eclipse', 100000, 'pps', 1000],
  ['Aura solar', 200000, 'click', 100],
  ['Polvo cósmico', 500000, 'pps', 200],
  ['Gema eterna', 1000000, 'click', 500],
  ['Esencia lúgubre', 2000000, 'pps', 1000],
  ['Corazón galáctico', 5000000, 'click', 5000],
  ['Núcleo de tiempo', 10000000, 'pps', 2000],
  ['Sombra viviente', 20000000, 'click', 10000],
  ['Aliento de cometa', 50000000, 'pps', 5000],
  ['Esfera de vacío', 100000000, 'click', 20000],
  ['Luz infinita', 200000000, 'pps', 10000],
  ['Vórtice de sueños', 500000000, 'click', 50000],
  ['Fragmento de aurora', 1000000000, 'pps', 25000],
  ['Pulso ancestral', 2000000000, 'click', 100000],
  ['Cúpula estelar', 5000000000, 'pps', 50000],
  ['Eco del vacío', 10000000000, 'click', 250000],
  ['Rayo de mañana', 20000000000, 'pps', 100000],
  ['Corazón de nebulosa', 50000000000, 'click', 500000],
  ['Alma de la selva', 100000000000, 'pps', 250000],
  ['Torrente de luz', 200000000000, 'click', 1000000],
  ['Resonancia eterna', 500000000000, 'pps', 500000],
  ['Nexus de almas', 1000000000000, 'click', 2000000],
  ['Horizonte fractal', 5000000000000, 'both', {click: 10000000, pps: 10000000}]
];

// ---------- estado en memoria ----------
let puntos = 0;
let puntosPorClic = 1;
let pps = 0;
let barValue = 0;
let buffActive = false;
let buffTimeout = null;
let buffExpiresAt = 0;
let prestigePoints = 0;
let prestigeExplained = false;
let currentImageLevel = 0;
let overlayPosition = null; // {left, top}
let lastSavedTimestamp = Date.now();

const mini = { count: 0, baseCost: 10, cost: 10, pps: 1 };
const hongos = { count: 0, baseCost: 100, cost: 100, pps: 5 };
const cristal = { count: 0, baseCost: 500, cost: 500, bonusClic: 10 };
const extras = rawExtrasInfo.map(([label, baseCost, type, bonus]) => ({
  label, count: 0, baseCost, cost: baseCost, type, bonus
}));

// precarga imágenes 0..3
for (let i = 0; i <= 3; i++) {
  const img = new Image();
  img.src = `./img/clicker/nivel${i}.png`;
  img.onerror = () => console.warn(`Error cargando nivel${i}.png`);
}

// ---------- utilidades ----------
function computeCost(baseCost, count) {
  if (count <= 4) return Math.floor(baseCost * Math.pow(1.15, count));
  return Math.floor(baseCost * Math.pow(1.15, 4) * Math.pow(1.08, count - 4));
}

function recalcPPS() {
  pps = mini.count * mini.pps + hongos.count * hongos.pps +
    extras.reduce((s, x) => s + ((x.type === 'pps' || x.type === 'both') ?
      x.count * (x.type === 'pps' ? x.bonus : x.bonus.pps) : 0), 0);
}

function prestigeMultiplier() { return 1 + prestigePoints * 0.1; }

function applyOfflineGain() {
  const now = Date.now();
  const deltaSec = Math.max(0, (now - lastSavedTimestamp) / 1000);
  if (deltaSec > 0) {
    const buffMult = buffActive ? 2 : 1;
    const gain = pps * buffMult * prestigeMultiplier() * deltaSec;
    puntos += gain;
  }
}

// ---------- guardado y carga ----------
function getSaveObject() {
  return {
    puntos,
    puntosPorClic,
    barValue,
    buffActive,
    buffExpiresAt: buffActive ? buffExpiresAt : 0,
    prestigePoints,
    prestigeExplained,
    currentImageLevel,
    overlayPosition,
    mini: { count: mini.count },
    hongos: { count: hongos.count },
    cristal: { count: cristal.count },
    extras: extras.map(e => ({ count: e.count })),
    lastSavedTimestamp: Date.now()
  };
}

function saveState() {
  try {
    const toSave = getSaveObject();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    lastSavedTimestamp = toSave.lastSavedTimestamp;
  } catch (e) {
    console.warn("Error guardando estado:", e);
  }
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const saved = JSON.parse(raw);

    if (typeof saved.puntos === "number") puntos = saved.puntos;
    if (typeof saved.puntosPorClic === "number") puntosPorClic = saved.puntosPorClic;
    if (typeof saved.barValue === "number") barValue = saved.barValue;
    if (saved.prestigePoints) prestigePoints = saved.prestigePoints;
    if (typeof saved.prestigeExplained === "boolean") prestigeExplained = saved.prestigeExplained;
    if (typeof saved.currentImageLevel === "number") currentImageLevel = saved.currentImageLevel;
    if (saved.overlayPosition && typeof saved.overlayPosition === "object") overlayPosition = saved.overlayPosition;
    if (saved.lastSavedTimestamp) lastSavedTimestamp = saved.lastSavedTimestamp;

    if (saved.mini && typeof saved.mini.count === "number") {
      mini.count = saved.mini.count;
      mini.cost = computeCost(mini.baseCost, mini.count);
    }
    if (saved.hongos && typeof saved.hongos.count === "number") {
      hongos.count = saved.hongos.count;
      hongos.cost = computeCost(hongos.baseCost, hongos.count);
    }
    if (saved.cristal && typeof saved.cristal.count === "number") {
      cristal.count = saved.cristal.count;
      cristal.cost = computeCost(cristal.baseCost, cristal.count);
    }

    // reconstruir puntosPorClic a partir de base + cristal + extras click/both
    puntosPorClic = 1;
    if (cristal.count > 0) {
      puntosPorClic += cristal.count * cristal.bonusClic;
    }

    if (Array.isArray(saved.extras)) {
      saved.extras.forEach((se, i) => {
        if (typeof se.count === "number" && extras[i]) {
          extras[i].count = se.count;
          extras[i].cost = computeCost(extras[i].baseCost, extras[i].count);
          if (extras[i].type === 'click') puntosPorClic += extras[i].count * extras[i].bonus;
          else if (extras[i].type === 'both') puntosPorClic += extras[i].count * extras[i].bonus.click;
        }
      });
    }

    recalcPPS();

    if (saved.buffActive && saved.buffExpiresAt && saved.buffExpiresAt > Date.now()) {
      buffActive = true;
      buffExpiresAt = saved.buffExpiresAt;
      const remaining = Math.max(0, buffExpiresAt - Date.now());
      document.getElementById('power-bar-circle').classList.add('active');
      document.getElementById('power-bar-icon').textContent = '×2';
      clearTimeout(buffTimeout);
      buffTimeout = setTimeout(() => {
        buffActive = false;
        document.getElementById('power-bar-circle').classList.remove('active');
        document.getElementById('power-bar-icon').textContent = '×1';
        buffExpiresAt = 0;
        saveState();
      }, remaining);
    } else {
      buffActive = false;
      buffExpiresAt = 0;
    }

    // aplicar ganancia offline
    applyOfflineGain();

  } catch (e) {
    console.warn("Error cargando estado, se usará el estado por defecto:", e);
  }
}

// ---------- interfaz dinámica de extras ----------
const upgContainer = document.getElementById('upgrades');
extras.forEach((u, i) => {
  const div = document.createElement('div');
  div.className = 'upgrade';
  div.id = `upgrade-extra${i+1}`;
  let efectoTexto = u.type === 'pps' ? `+${u.bonus} por segundo` :
    (u.type === 'click' ? `+${u.bonus} por clic` :
      `+${u.bonus.click} por clic y +${u.bonus.pps} por segundo`);
  div.innerHTML = `
    <p>${u.label}: <span id="extra${i+1}-count">0</span></p>
    <p>Coste: <span id="extra${i+1}-cost">${u.cost}</span></p>
    <p>${efectoTexto}</p>
    <button id="btn-extra${i+1}">Comprar</button>
  `;
  upgContainer.appendChild(div);
});

// ---------- actualización visual ----------
function updateUI() {
  const buffMult = buffActive ? 2 : 1;
  const totalMult = buffMult * prestigeMultiplier();
  document.getElementById('puntos').textContent = puntos.toFixed(2);
  document.getElementById('porClic').textContent = (puntosPorClic * totalMult).toFixed(2);
  document.getElementById('pps').textContent = (pps * totalMult).toFixed(2);
  document.getElementById('prestige-mult').textContent = `Multiplicador: ×${prestigeMultiplier().toFixed(2)}`;
  document.getElementById('prestige-points').textContent = `Prestige points: ${prestigePoints}`;
  document.getElementById('mini-count').textContent = mini.count;
  document.getElementById('mini-cost').textContent = mini.cost;
  document.getElementById('hongo-count').textContent = hongos.count;
  document.getElementById('hongo-cost').textContent = hongos.cost;
  document.getElementById('cristal-count').textContent = cristal.count;
  document.getElementById('cristal-cost').textContent = cristal.cost;
  document.getElementById('btn-mini').disabled = puntos < mini.cost;
  document.getElementById('btn-hongo').disabled = puntos < hongos.cost;
  document.getElementById('btn-cristal').disabled = puntos < cristal.cost;
  extras.forEach((u, i) => {
    const countEl = document.getElementById(`extra${i+1}-count`);
    const costEl = document.getElementById(`extra${i+1}-cost`);
    const btn = document.getElementById(`btn-extra${i+1}`);
    if (countEl) countEl.textContent = u.count;
    if (costEl) costEl.textContent = u.cost;
    if (btn) btn.disabled = puntos < u.cost;
  });
  // prestige button inline habilitado si puede
  document.getElementById('btn-prestige-inline').disabled = puntos < 1_000_000;
  const prestigeBtn = document.getElementById('btn-prestige');
  if (prestigeBtn) prestigeBtn.disabled = puntos < 1_000_000;
}

// ---------- barra de poder ----------
function updateBar() {
  if (!buffActive) {
    barValue = Math.max(0, barValue - barDecayPerSec / 10);
    document.getElementById('power-bar-fill').style.height = barValue + '%';
  }
}

// ---------- buff ----------
function startBuff() {
  buffActive = true;
  buffExpiresAt = Date.now() + buffDuration;
  document.getElementById('power-bar-circle').classList.add('active');
  document.getElementById('power-bar-icon').textContent = '×2';
  clearTimeout(buffTimeout);
  buffTimeout = setTimeout(() => {
    buffActive = false;
    document.getElementById('power-bar-circle').classList.remove('active');
    document.getElementById('power-bar-icon').textContent = '×1';
    buffExpiresAt = 0;
    saveState();
  }, buffDuration);
  saveState();
}

function calculatePointsFromPuntos(c) {
  if (c >= 100_000_000) return 4 + Math.floor((c - 100_000_000) / 50_000_000);
  else if (c >= 50_000_000) return 2;
  else if (c >= 1_000_000) return 1;
  return 0;
}

// ---------- imagen ----------
function setImageLevel(level) {
  level = Math.min(Math.max(0, level), 3);
  if (level === currentImageLevel) return;
  currentImageLevel = level;
  const imgEl = document.getElementById('main-image');
  imgEl.src = `./img/clicker/nivel${level}.png`;
  imgEl.onerror = () => console.warn('No se pudo cargar imagen nivel', level);
  saveState();
}

// ---------- carga inicial ----------
loadState();
recalcPPS();
updateUI();
setImageLevel(currentImageLevel);
document.getElementById('power-bar-fill').style.height = barValue + '%';
if (overlayPosition) {
  const overlay = document.getElementById('stats-overlay');
  overlay.style.left = (overlayPosition.left) + 'px';
  overlay.style.top = (overlayPosition.top) + 'px';
}
if (buffActive) {
  document.getElementById('power-bar-circle').classList.add('active');
  document.getElementById('power-bar-icon').textContent = '×2';
}

// ---------- manejadores de eventos ----------
document.getElementById('firefly-btn').addEventListener('pointerdown', e => {
  e.preventDefault();
  if (barValue >= activationThreshold && !buffActive) startBuff();
  const gain = puntosPorClic * (buffActive ? 2 : 1) * prestigeMultiplier();
  puntos += gain;
  barValue = Math.min(barValue + barIncrease, 100);
  document.getElementById('power-bar-fill').style.height = barValue + '%';
  const rect = document.getElementById('farm').getBoundingClientRect();
  const span = document.createElement('span');
  span.className = 'float-text';
  span.textContent = '+' + gain.toFixed(2);
  span.style.left = (e.clientX - rect.left) + 'px';
  span.style.top = (e.clientY - rect.top) + 'px';
  document.getElementById('farm').appendChild(span);
  span.addEventListener('animationend', () => span.remove());
  updateUI();
  saveState();
});

document.getElementById('btn-mini').onclick = () => {
  if (puntos >= mini.cost) {
    puntos -= mini.cost;
    mini.count++;
    mini.cost = computeCost(mini.baseCost, mini.count);
    recalcPPS();
    updateUI();
    if (mini.count === 1) setImageLevel(1);
    saveState();
  }
};
document.getElementById('btn-hongo').onclick = () => {
  if (puntos >= hongos.cost) {
    puntos -= hongos.cost;
    hongos.count++;
    hongos.cost = computeCost(hongos.baseCost, hongos.count);
    recalcPPS();
    updateUI();
    if (hongos.count === 1) setImageLevel(2);
    saveState();
  }
};
document.getElementById('btn-cristal').onclick = () => {
  if (puntos >= cristal.cost) {
    puntos -= cristal.cost;
    cristal.count++;
    puntosPorClic = 1 + cristal.count * cristal.bonusClic; // reconstruye base
    // también sumar extras click/both
    extras.forEach(u => {
      if (u.type === 'click') puntosPorClic += u.count * u.bonus;
      else if (u.type === 'both') puntosPorClic += u.count * u.bonus.click;
    });
    cristal.cost = computeCost(cristal.baseCost, cristal.count);
    updateUI();
    if (cristal.count === 1) setImageLevel(3);
    saveState();
  }
};
extras.forEach((u, i) => {
  document.getElementById(`btn-extra${i+1}`).onclick = () => {
    if (puntos >= u.cost) {
      puntos -= u.cost;
      u.count++;
      if (u.type === 'click') puntosPorClic += u.bonus;
      else if (u.type === 'both') puntosPorClic += u.bonus.click;
      if (u.type !== 'click') recalcPPS();
      u.cost = computeCost(u.baseCost, u.count);
      updateUI();
      saveState();
    }
  };
});

function attemptPrestige() {
  if (puntos < 1_000_000) return;
  if (!prestigeExplained) { alert('Prestige: reinicia todo a cambio de prestige points.'); prestigeExplained = true; }
  const gained = calculatePointsFromPuntos(puntos);
  if (gained < 1) return;
  if (!confirm(`¿Activar Prestige y ganar ${gained} puntos?`)) return;
  prestigePoints += gained;
  puntos = 0;
  puntosPorClic = 1;
  mini.count = 0; hongos.count = 0; cristal.count = 0;
  mini.cost = computeCost(mini.baseCost, mini.count);
  hongos.cost = computeCost(hongos.baseCost, hongos.count);
  cristal.cost = computeCost(cristal.baseCost, cristal.count);
  extras.forEach(u => {
    u.count = 0;
    u.cost = computeCost(u.baseCost, 0);
  });
  recalcPPS();
  updateUI();
  setImageLevel(0);
  saveState();
}
document.getElementById('btn-prestige').onclick = attemptPrestige;
document.getElementById('btn-prestige-inline').onclick = attemptPrestige;

// arrastrar el overlay de stats y guardar posición
(() => {
  const overlay = document.getElementById('stats-overlay');
  let dragging = false;
  let offsetX = 0, offsetY = 0;

  overlay.addEventListener('pointerdown', e => {
    dragging = true;
    overlay.setPointerCapture(e.pointerId);
    const rect = overlay.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    e.preventDefault();
  });

  overlay.addEventListener('pointermove', e => {
    if (!dragging) return;
    let x = e.clientX - offsetX;
    let y = e.clientY - offsetY;
    x = Math.max(0, Math.min(window.innerWidth - overlay.offsetWidth, x));
    y = Math.max(0, Math.min(window.innerHeight - overlay.offsetHeight, y));
    overlay.style.left = x + 'px';
    overlay.style.top = y + 'px';
  });

  overlay.addEventListener('pointerup', e => {
    dragging = false;
    try { overlay.releasePointerCapture(e.pointerId); } catch {}
    // guardamos posición
    const rect = overlay.getBoundingClientRect();
    overlayPosition = { left: rect.left, top: rect.top };
    saveState();
  });
})();

// ---------- bucles ----------
// decaimiento de barra
setInterval(() => {
  updateBar();
  saveState(); // guardar decay/valor de barra
}, 100);
// ganancia pasiva por segundo
setInterval(() => {
  puntos += pps * (buffActive ? 2 : 1) * prestigeMultiplier();
  updateUI();
  saveState();
}, 1000);

// guardar periódico de seguridad (cada 5s)
setInterval(() => {
  saveState();
}, 5000);

// guardar antes de cerrar
window.addEventListener("beforeunload", () => {
  saveState();
});
</script>
</body>
</html>
