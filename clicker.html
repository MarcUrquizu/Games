<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Clicker de Puntos</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
<style>
  html, body { touch-action: manipulation; height: 100%; margin: 0; overflow: hidden; background: #1f1f27; color: #fff; font-family: 'Montserrat', sans-serif; }
  .top-left-buttons { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 14px; z-index: 50; }
  .game-buttons { background-color: rgba(0,0,0,0.8); color: #fff; font-weight: bold; text-decoration: none; padding: 8px 14px; border-radius: 6px; font-family: 'Press Start 2P', cursive; font-size: 0.65rem; letter-spacing: 1px; box-shadow: 0 2px 6px rgba(0,0,0,.5); transition: background .2s; display: inline-block; }
  .game-buttons:hover { background-color: rgba(255,255,255,0.1); }
  #game-container { display: flex; height: 100%; }
  #farm { flex: 1; position: relative; background: #282c34; display: flex; align-items: center; justify-content: center; overflow: hidden; }
  #stats-overlay { position: absolute; top: 1rem; left: 7rem; background: rgba(0,0,0,.7); padding: .5rem 1rem; border-radius: 6px; font-family: 'Press Start 2P', cursive; text-shadow: 1px 1px 2px #000; z-index: 10; font-size: 0.9rem; min-width: 160px; }
  #stats-overlay p { margin: 4px 0; line-height: 1.2; }
  #btn-prestige {
    margin-top: 8px;
    padding: 8px 14px;
    font-family: 'Press Start 2P', cursive;
    font-size: 0.7rem;
    border-radius: 8px;
    border: none;
    background-color: #555;
    color: #fff;
    transition: background 0.2s;
    cursor: not-allowed;
  }
  #btn-prestige.enabled {
    background-color: #ff9800;
    cursor: pointer;
  }
  #firefly-btn { background: none; border: none; cursor: pointer; position: relative; z-index: 5; }
  #firefly-btn img { width: 40vw; max-width: 500px; transition: transform .1s; }
  #firefly-btn img:active { transform: scale(.9); }
  #power-bar-container { position: absolute; bottom: 1rem; left: 1rem; width: 6vw; max-width: 30px; height: 25vh; max-height: 200px; background: rgba(255,255,255,.1); border: 2px solid #aaa; border-radius: 15px; overflow: visible; z-index: 5; }
  #power-bar-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: #e74c3c; transition: height .1s linear; border-bottom-left-radius: 13px; border-bottom-right-radius: 13px; }
  #power-bar-circle { position: absolute; top: -20%; left: 50%; transform: translateX(-50%); width: 10vw; max-width: 50px; height: 10vw; max-height: 50px; background: #555; border: 3px solid #777; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Press Start 2P', cursive; font-size: 1rem; color: #fff; opacity: .25; transition: opacity .3s, box-shadow .3s, background .3s; z-index: 6; }
  #power-bar-circle.active { opacity: 1; background: #ffeb3b; color: #000; box-shadow: 0 0 8px rgba(255,235,59,.8); }
  .float-text { position: absolute; font-family:'Press Start 2P', cursive; font-size: 1.2rem; color: #00eaff; text-shadow: 1px 1px 2px #000; pointer-events: none; animation: floatUp 1.2s ease-out forwards; z-index: 10; }
  @keyframes floatUp { to { opacity: 0; transform: translateY(-80px); } }
  #upgrades { width: 30vw; max-width: 450px; flex-shrink: 0; background: #fff; padding: 1rem; box-sizing: border-box; overflow-y: auto; color: #000; }
  #upgrades h2 { font-family: 'Press Start 2P', cursive; margin: 0 0 1rem; }
  .upgrade { background: #fff; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,.2); }
  .upgrade p { margin: .3rem 0; font-family: 'Press Start 2P', cursive; }
  .upgrade button {
    padding: .5rem 1rem;
    background: #444;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background .2s;
    box-shadow: 0 2px 5px rgba(0,0,0,.2);
    color: #fff;
  }
  .upgrade button:not(:disabled) { background: #61dafb; color: #000; }
  .upgrade button:not(:disabled):hover { background: #21a1f1; }
  .upgrade button:disabled { background: #bbb; cursor: not-allowed; color: #666; }
  @media (max-width: 900px) { #game-container { flex-direction: column; } #upgrades { width: 100%; max-height: 40vh; overflow-y: scroll; } #farm { height: 60vh; } }
</style>
</head>
<body>

<div class="top-left-buttons">
  <a href="./help.html" class="game-buttons">INFO</a>
  <a href="./index.html" class="game-buttons">MENU</a>
</div>

<div id="game-container">
  <div id="farm">
    <div id="stats-overlay">
      <p>Puntos: <span id="puntos">0.00</span></p>
      <p>Por clic: <span id="porClic">1.00</span></p>
      <p>Por segundo: <span id="pps">0.00</span></p>
      <p id="prestige-mult">Multiplicador: ×1.00</p>
      <p id="prestige-points">Prestige points: 0</p>
      <button id="btn-prestige" disabled>Prestige</button>
    </div>
    <button id="firefly-btn">
      <img id="main-image" src="./img/clicker/nivel0.png" alt="Nivel 0" />
    </button>
    <div id="power-bar-container">
      <div id="power-bar-fill"></div>
      <div id="power-bar-circle"><span id="power-bar-icon">×1</span></div>
    </div>
  </div>
  <div id="upgrades">
    <h2>Mejoras</h2>
    <!-- todas las mejoras, incluyendo las base, se inyectan dinámicamente -->
  </div>
</div>

<script>
const rawBaseInfo = [
  ['Mini generador', 10, 'pps', 1, 'mini'],
  ['Colmena de hongos', 50, 'pps', 5, 'hongos'],
  ['Cristal mágico', 100, 'click', 10, 'cristal']
];
const rawExtrasInfo = [
  ['Luz de aurora',500,'pps',10],['Néctar ancestral',1000,'click',10],['Eco estelar',2000,'pps',20],['Aura mística',5000,'click',50],
  ['Corazón de eclipse',10000,'pps',100],['Aura solar',20000,'click',100],['Polvo cósmico',50000,'pps',200],['Gema eterna',100000,'click',500],
  ['Esencia lúgubre',200000,'pps',1000],['Corazón galáctico',500000,'click',1000],['Núcleo de tiempo',1000000,'pps',2000],['Sombra viviente',2000000,'click',2000],
  ['Aliento de cometa',5000000,'pps',5000],['Esfera de vacío',10000000,'click',5000],['Luz infinita',20000000,'pps',10000],['Vórtice de sueños',50000000,'click',10000],
  ['Fragmento de aurora',100000000,'pps',25000],['Pulso ancestral',200000000,'click',25000],['Cúpula estelar',500000000,'pps',50000],['Eco del vacío',1000000000,'click',50000],
  ['Rayo de mañana',2000000000,'pps',100000],['Corazón de nebulosa',5000000000,'click',100000],['Alma de la selva',10000000000,'pps',250000],['Torrente de luz',20000000000,'click',250000],
  ['Resonancia eterna',50000000000,'pps',500000],['Nexus de almas',100000000000,'click',500000],['Horizonte fractal',500000000000,'both',{click:1000000,pps:1000000}]
];

// un solo array de mejoras
const upgrades = [
  ...rawBaseInfo.map(([label, baseCost, type, bonus, key]) => ({
    label,
    key,
    baseCost,
    cost: baseCost,
    type,
    bonus,
    count: 0
  })),
  ...rawExtrasInfo.map(([label, baseCost, type, bonus], i) => ({
    label,
    key: `extra${i+1}`,
    baseCost,
    cost: baseCost,
    type,
    bonus,
    count: 0
  }))
];

let puntos = 0;
let puntosPorClic = 1;
let pps = 0;
let barValue = 0;
let buffActive = false;
let buffTimeout;
let prestigePoints = 0;
const barIncrease = 6;
const barDecayPerSec = 10;
const buffDuration = 2000;
const activationThreshold = 95;
let currentImageLevel = 0;
const MAX_IMAGE_LEVEL = 30;

function setImageLevel(l){
  currentImageLevel = Math.min(Math.max(0,l), MAX_IMAGE_LEVEL);
  document.getElementById('main-image').src = `./img/clicker/nivel${currentImageLevel}.png`;
}

function computeCost(b,c){ return Math.floor(b * Math.pow(1.15, c)); }

function recalcPPS(){
  pps = upgrades.reduce((sum, u) => {
    if (u.type === 'pps') return sum + u.count * u.bonus;
    if (u.type === 'both') return sum + u.count * u.bonus.pps;
    return sum;
  }, 0);
}

function recalcPorClic(){
  puntosPorClic = 1 + upgrades.reduce((sum, u) => {
    if (u.type === 'click') return sum + u.count * u.bonus;
    if (u.type === 'both') return sum + u.count * u.bonus.click;
    return sum;
  }, 0);
}

function prestigeMultiplier(){ return 1 + prestigePoints * 0.1; }

function updateUI(){
  const t = (buffActive ? 2 : 1) * prestigeMultiplier();
  document.getElementById('puntos').textContent = puntos.toFixed(2);
  document.getElementById('porClic').textContent = (puntosPorClic * t).toFixed(2);
  document.getElementById('pps').textContent = (pps * t).toFixed(2);
  document.getElementById('prestige-mult').textContent = `Multiplicador: ×${prestigeMultiplier().toFixed(2)}`;
  document.getElementById('prestige-points').textContent = `Prestige points: ${prestigePoints}`;

  upgrades.forEach(u => {
    const countEl = document.getElementById(`${u.key}-count`);
    const costEl = document.getElementById(`${u.key}-cost`);
    const btn = document.getElementById(`btn-${u.key}`);
    if (countEl) countEl.textContent = u.count;
    if (costEl) costEl.textContent = u.cost;
    if (btn) btn.disabled = puntos < u.cost;
  });

  const prestigeBtn = document.getElementById('btn-prestige');
  if (puntos >= 1000000){
    prestigeBtn.classList.add('enabled');
    prestigeBtn.disabled = false;
  } else {
    prestigeBtn.classList.remove('enabled');
    prestigeBtn.disabled = true;
  }
}

function updateBar(){
  if (!buffActive){
    barValue = Math.max(0, barValue - barDecayPerSec / 10);
    document.getElementById('power-bar-fill').style.height = barValue + '%';
  }
}
function startBuff(){
  buffActive = true;
  document.getElementById('power-bar-circle').classList.add('active');
  document.getElementById('power-bar-icon').textContent = '×2';
  clearTimeout(buffTimeout);
  buffTimeout = setTimeout(()=>{
    buffActive = false;
    document.getElementById('power-bar-circle').classList.remove('active');
    document.getElementById('power-bar-icon').textContent = '×1';
  }, buffDuration);
}

function getPrestigeGain(puntos){
  const thresholds = [
    50000000000, // 50,000M => 10
    10000000000, // 10,000M => 9
    5000000000,  // 5,000M  => 8
    1000000000,  // 1,000M  => 7
    500000000,   // 500M    => 6
    100000000,   // 100M    => 5
    50000000,    // 50M     => 4
    10000000,    // 10M     => 3
    5000000,     // 5M      => 2
    1000000      // 1M      => 1
  ];
  const gains = [10,9,8,7,6,5,4,3,2,1];
  for (let i = 0; i < thresholds.length; i++) {
    if (puntos >= thresholds[i]) return gains[i];
  }
  return 0;
}

function attemptPrestige(){
  const gained = getPrestigeGain(puntos);
  if (gained === 0) return;
  if(!confirm(`¿Activar Prestige y ganar ${gained} puntos?`)) return;
  prestigePoints += gained;
  puntos = 0;
  puntosPorClic = 1;
  upgrades.forEach(u => {
    u.count = 0;
    u.cost = u.baseCost;
  });
  recalcPPS();
  recalcPorClic();
  currentImageLevel = 0;
  setImageLevel(0);
  updateUI();
  saveGame();
}

function saveGame(){
  localStorage.setItem('clickerGame', JSON.stringify({
    puntos,
    puntosPorClic,
    upgrades,
    prestigePoints,
    currentImageLevel
  }));
}
function loadGame(){
  const s = JSON.parse(localStorage.getItem('clickerGame'));
  if (!s) return;
  puntos = s.puntos;
  puntosPorClic = s.puntosPorClic;
  if (s.upgrades){
    s.upgrades.forEach(saved => {
      const u = upgrades.find(x => x.key === saved.key);
      if (u){
        Object.assign(u, saved);
      }
    });
  }
  prestigePoints = s.prestigePoints;
  currentImageLevel = s.currentImageLevel || 0;
  setImageLevel(currentImageLevel);
  recalcPPS();
  recalcPorClic();
}

// Construcción dinámica del DOM
const upgContainer = document.getElementById('upgrades');
upgrades.forEach(u => {
  const d = document.createElement('div');
  d.className = 'upgrade';
  let bonusText;
  if (u.type === 'pps') bonusText = `+${u.bonus} por segundo`;
  else if (u.type === 'click') bonusText = `+${u.bonus} por clic`;
  else if (u.type === 'both') bonusText = `+${u.bonus.click} por clic y +${u.bonus.pps} por segundo`;
  d.innerHTML = `
    <p>${u.label}: <span id="${u.key}-count">0</span></p>
    <p>Coste: <span id="${u.key}-cost">${u.cost}</span></p>
    <p>${bonusText}</p>
    <button id="btn-${u.key}">Comprar</button>
  `;
  upgContainer.appendChild(d);
  document.getElementById(`btn-${u.key}`).onclick = () => {
    if (puntos >= u.cost){
      puntos -= u.cost;
      u.count++;
      if (u.count === 1) setImageLevel(currentImageLevel + 1);
      if (u.type === 'click' || u.type === 'both') recalcPorClic();
      if (u.type === 'pps' || u.type === 'both') recalcPPS();
      u.cost = computeCost(u.baseCost, u.count);
      recalcPPS();
      recalcPorClic();
      updateUI();
      saveGame();
    }
  };
});

// Eventos principales
document.getElementById('firefly-btn').addEventListener('click', e => {
  if (barValue >= activationThreshold && !buffActive) startBuff();
  const g = puntosPorClic * (buffActive ? 2 : 1) * prestigeMultiplier();
  puntos += g;
  barValue = Math.min(barValue + barIncrease, 100);
  document.getElementById('power-bar-fill').style.height = barValue + '%';
  const r = document.getElementById('farm').getBoundingClientRect();
  const s = document.createElement('span');
  s.className = 'float-text';
  s.textContent = '+' + g.toFixed(2);
  s.style.left = (e.clientX - r.left) + 'px';
  s.style.top = (e.clientY - r.top) + 'px';
  document.getElementById('farm').appendChild(s);
  s.addEventListener('animationend', ()=> s.remove());
  updateUI();
  saveGame();
});

document.getElementById('btn-prestige').onclick = attemptPrestige;

// Loops
setInterval(updateBar, 100);
setInterval(()=>{
  puntos += pps * (buffActive ? 2 : 1) * prestigeMultiplier();
  updateUI();
  saveGame();
}, 1000);

// Inicialización
loadGame();
recalcPPS();
recalcPorClic();
updateUI();
setImageLevel(currentImageLevel);
</script>
</body>
</html>
